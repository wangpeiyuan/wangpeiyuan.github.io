<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>æºæ¥ä¼¼ä½ </title>
  
  <subtitle>ä¸€ä¸ªå‘å¾€è‡ªç”±çš„å¼€å‘å·¥ç¨‹å¸ˆ</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://wangpeiyuan.cn/"/>
  <updated>2020-05-11T06:37:52.541Z</updated>
  <id>http://wangpeiyuan.cn/</id>
  
  <author>
    <name>ç‹åŸ¹æº</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å¦‚ä½•è‡ªåŠ¨æ‰¹é‡å–æ¶ˆæŠ–éŸ³å–œæ¬¢çš„è§†é¢‘</title>
    <link href="http://wangpeiyuan.cn/2020/05/11/How-to-automatically-cancel-likes-on-Douyin-app/"/>
    <id>http://wangpeiyuan.cn/2020/05/11/How-to-automatically-cancel-likes-on-Douyin-app/</id>
    <published>2020-05-11T03:24:01.000Z</published>
    <updated>2020-05-11T06:37:52.541Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æœ‰æƒ³åœ¨æŠ–éŸ³ä¸Šå‘å¸ƒè§†é¢‘ï¼Œä¸æƒ³å†æ³¨å†Œä¸ªæ–°å·ï¼Œä½†åŸæ¥çš„è´¦å·ä¹‹å‰åœ¨æŠ–éŸ³ä¸Šç‚¹èµäº†å¥½å¤šè§†é¢‘ï¼Œä¸ªäººä¸»é¡µä¸­å–œæ¬¢æœ‰å°†è¿‘ 1 åƒä¸ªï¼Œä¸å¤ªå–œæ¬¢ï¼Œæƒ³å½“ä¸€ä¸ªæ–°å·æ¥ä½¿ç”¨çš„è¯ï¼Œå¿…é¡»å°†è¿™äº›å–œæ¬¢å–æ¶ˆæ‰ã€‚</p><p>æ‰‹åŠ¨å–æ¶ˆçš„è¯ï¼Œæ„Ÿè§‰ç‰¹åˆ«éº»çƒ¦ï¼Œè®¨åŒé‡å¤æ€§çš„åŠ¨ä½œã€‚ç½‘ä¸Šæœäº†ä¸€åœˆï¼ŒåŸºæœ¬æ²¡æ‰¾åˆ°è‡ªåŠ¨å–æ¶ˆçš„æ–¹æ¡ˆï¼Œå®åœ¨æ˜¯æ²¡æ’¤äº†ï¼Œä½œä¸ºä¸€ä¸ªå¼€å‘è€…ï¼Œæœ€ååªèƒ½è‡ªå·±åŠ¨æ‰‹ä¸°è¡£è¶³é£Ÿäº†ã€‚</p><p>åˆæ­¥ä¸€æƒ³ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š</p><ol><li>æ‰¾åˆ°æŠ–éŸ³çš„è¯·æ±‚æ¥å£ï¼Œæ‰¹é‡å¾ªç¯ä¸€éã€‚</li><li>åœ¨æ‰‹æœºä¸Šæ¨¡æ‹Ÿç‚¹å‡»æ“ä½œã€‚</li></ol><a id="more"></a><p>æ–¹æ¡ˆ 1 çš„è¯å¦‚æœèƒ½æ‰¾åˆ°å¯¹åº”æ¥å£çš„è¯æ˜¯æœ€å¿«çš„ï¼Œéº»çƒ¦ç‚¹åœ¨äºéœ€è¦å¯»æ‰¾æ¥å£ä»¥åŠèƒ½æ‰¾åˆ°ä¹‹åæ¥å£è¯·æ±‚å„ç§éªŒè¯ï¼Œç›¸å¯¹äºæ–¹æ¡ˆ 2 äºæˆ‘æ¥è¯´ç›¸å¯¹éº»çƒ¦ä¸å°‘ï¼ˆä½œä¸ºä¸€ä¸ª Android å¼€å‘è€…ï¼‰ï¼Œæ‰€ä»¥æˆ‘åªèƒ½æ”¾å¼ƒæ–¹æ¡ˆ 1 é€‰æ‹©æ–¹æ¡ˆ 2 äº†ã€‚</p><p>åœ¨ Android ä¸Šæƒ³æ¨¡æ‹Ÿç‚¹å‡»æ“ä½œï¼Œæ¯«æ— ç–‘é—®åªèƒ½ä½¿ç”¨æ— éšœç¢æœåŠ¡ï¼Œæ¯”å¦‚ä¹‹å‰å¾ˆç«çš„å¾®ä¿¡è‡ªåŠ¨æŠ¢çº¢åŒ…ï¼Œä¹Ÿæ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå½“ç„¶ xposed ä¹Ÿæ˜¯å¯ä»¥ï¼Œä½†æˆ‘å®åœ¨ä¸æ‡‚å•ŠğŸ˜‚ã€‚æ— éšœç¢æ¨¡æ‹Ÿç‚¹å‡»é€šä¿—æ¥è®²ï¼Œå°±æ˜¯åœ¨å½“å‰ç•Œé¢ä¸­æ‰¾åˆ°éœ€è¦ç‚¹å‡»çš„è§†å›¾ï¼Œæ¯”å¦‚æˆ‘ä»¬ç°åœ¨è¦åšçš„æŠ–éŸ³å–œæ¬¢æŒ‰é’®ï¼Œæ‰¾åˆ°è§†å›¾ä¹‹åé€šè¿‡æ¨¡æ‹Ÿç‚¹å‡»æ–¹æ³•è§¦å‘ç‚¹å‡»äº‹ä»¶ã€‚</p><p>æ¥ä¸‹æ¥å°±å¼€å§‹æˆ‘ä»¬çš„å·¥ç¨‹ï¼Œé¦–å…ˆæ˜¯é…ç½®é¡¹ç›®ï¼Œæ‰¾åˆ°æŠ–éŸ³çš„åŒ…åï¼Œä½¿å¾—æ— éšœç¢æœåŠ¡ä»…ç›‘å¬æŠ–éŸ³çš„äº‹ä»¶ï¼Œå…å¾—æ‰‹æœºå¡é¡¿ã€‚æœ€é‡è¦çš„æ˜¯ç»§æ‰¿ <code>AccessibilityService</code> ç±»æ¥ç›‘å¬é¡µé¢å˜åŒ–ç­‰äº‹ä»¶ï¼Œå…·ä½“è¿‡ç¨‹çœ‹çœ‹ Android å¼€å‘å®˜ç½‘æˆ–è€…ç½‘ä¸Šçš„æ•™ç¨‹éƒ½æŒºå¤šçš„ï¼Œå°±ä¸åœ¨è¿™é‡Œèµ˜è¿°ã€‚</p><p>ç„¶åï¼Œç”¨å¼€å‘å·¥å…· Monitor æŸ¥çœ‹æŠ–éŸ³çš„å¸ƒå±€ï¼Œæ‰¾åˆ°å–œæ¬¢ç›¸å…³è§†å›¾ï¼Œ</p><p><img src="/2020/05/11/How-to-automatically-cancel-likes-on-Douyin-app/douyindislike_1.png" alt="douyindislike_like"></p><p>æ ¹æ®ä¸Šå›¾ï¼Œå¯ä»¥æ‰¾åˆ°å–œæ¬¢çš„è§†å›¾å’Œå®ƒçš„ idï¼Œè¿™ä¸ªä¸»è¦æ˜¯ç”¨æ¥å®šä½æ˜¯ä¸æ˜¯åœ¨ä¸ªäººä¸»é¡µå–œæ¬¢çš„ tab ä¸‹é¢ï¼Œç„¶åé€šè¿‡ <code>AccessibilityNodeInfo.findAccessibilityNodeInfosByText(&quot;å–œæ¬¢&quot;)</code> æ¥æ‰¾åˆ°å¯¹åº”çš„ç»“ç‚¹ï¼Œä¸ç”¨ id çš„åŸå› æ˜¯å…¼å®¹ï¼Œä¸åŒç‰ˆæœ¬çš„æŠ–éŸ³ id æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>ç¡®è®¤åœ¨ä¸ªäººä¸»é¡µä¹‹åï¼Œå°±è¦æ‰¾åˆ°è§†é¢‘ itemï¼Œ</p><p><img src="/2020/05/11/How-to-automatically-cancel-likes-on-Douyin-app/douyindislike_2.png" alt="douyindislike_video_item"></p><p>åŒæ ·é€šè¿‡ <code>AccessibilityNodeInfo.findAccessibilityNodeInfosByText(&quot;è§†é¢‘&quot;)</code> æ‰¾åˆ°å¯¹åº”ç»“ç‚¹ï¼Œç„¶åé€šè¿‡ <code>performAction(AccessibilityNodeInfo.ACTION_CLICK)</code> æ¨¡æ‹Ÿç‚¹å‡»ï¼Œå°±ä¼šè·³è½¬åˆ°è§†é¢‘çš„è¯¦æƒ…é¡µé¢ã€‚</p><p><img src="/2020/05/11/How-to-automatically-cancel-likes-on-Douyin-app/douyindislike_3.png" alt="douyindislike_video_detail"></p><p>åœ¨ä¸Šå›¾ï¼Œå¯ä»¥å‘ç°åœ¨è§†é¢‘è¯¦æƒ…é¡µï¼Œæ ¹æœ¬æ‰¾ä¸åˆ°ä»»ä½•ç»“ç‚¹è®©æˆ‘ä»¬æ¨¡æ‹Ÿç‚¹å‡»ï¼Œä¹Ÿå°±æ˜¯è¯´é€šè¿‡æ‰¾åˆ°è§†å›¾ç»“ç‚¹æ¨¡æ‹Ÿæ“ä½œåœ¨è¿™ä¸ªç•Œé¢æ ¹æœ¬æ— æ³•åšåˆ°ï¼</p><p>æ€ä¹ˆåŠï¼Ÿ</p><p>åªèƒ½å›å»ç¿»ç¿»å®˜æ–¹æ–‡æ¡£ï¼Œå¯ä»¥å‘ç°ä¸€ä¸ªå±æ€§ <code>android:canPerformGestures=&quot;true&quot;</code>ï¼Œè¿™æ ·å­å°±å¯ä»¥åœ¨æ‰‹æœºä¸Šæ¨¡æ‹Ÿæ‰‹åŠ¿æ“ä½œäº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå±æ€§ä»…æ”¯æŒ Android 7.0 åŠå…¶ä»¥ä¸Šçš„ç‰ˆæœ¬ã€‚</p><p>è®¾ç½®ä¸Šé¢çš„å±æ€§ï¼Œåœ¨ <code>AccessibilityService</code> ä¸­æˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ä¸€ä¸ªæ–¹æ³• <code>dispatchGesture(GestureDescription,GestureResultCallback,Handler)</code>ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯æ ¹æ®å±å¹•çš„åæ ‡ç‚¹æ¨¡æ‹Ÿæ‰‹åŠ¿æ“ä½œï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ç‚¹å‡»ã€‚</p><p>æ‰€ä»¥ï¼Œæ­¤æ—¶å°±å¾—æ‰¾åˆ°æŠ–éŸ³è§†é¢‘é¡µé¢å–œæ¬¢æŒ‰é’®åœ¨å±å¹•ä¸Šçš„åæ ‡ï¼Œç”±äºä¸åŒæ‰‹æœºåæ ‡ç‚¹è‚¯å®šä¸ä¸€æ ·ï¼Œå› æ­¤æ²¡åŠæ³•æ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œé€šè¿‡å±å¹•ç™¾åˆ†æ¯”çš„è¯ï¼Œæœ‰ä¸€å®šçš„å¯è¡Œæ€§ï¼Œä½†ä¸èƒ½ä¿è¯ç™¾åˆ†ç™¾ã€‚å› æ­¤æƒ³äº†å¦ä¸€ä¸ªæ–¹æ¡ˆï¼Œé€šè¿‡æ‚¬æµ®çª—æ‰‹åŠ¨å®šä½åˆ°æŒ‰é’®ä½ç½®ã€‚</p><p>æœ€åï¼Œåœ¨å¤„ç†ä¸€ä¸‹ç»†èŠ‚ï¼ŒåŸºæœ¬ä¸Šå°±æˆå‹äº†ã€‚</p><p><img src="/2020/05/11/How-to-automatically-cancel-likes-on-Douyin-app/douyindislike_app.png" alt="douyindislike_app"></p><p>æœ€ååœ¨æ‰‹æœºä¸Šå®‰è£…è¿è¡ŒéªŒè¯ä¸€ä¸‹ï¼Œ1 åƒå·¦å³å…¨éƒ¨å–æ¶ˆåŸºæœ¬åœ¨ 10 åˆ†é’Ÿä»¥å†…å®Œæˆï¼Œæ—¶é—´è¿˜è¡Œï¼Œä¸è¿‡ä¸ºäº†å†™è¿™ä¸ªç¨‹åºèŠ±äº†æˆ‘å‘¨æœ«ä¸€ä¸ªç™½å¤©ğŸ˜‚ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘æœ‰æƒ³åœ¨æŠ–éŸ³ä¸Šå‘å¸ƒè§†é¢‘ï¼Œä¸æƒ³å†æ³¨å†Œä¸ªæ–°å·ï¼Œä½†åŸæ¥çš„è´¦å·ä¹‹å‰åœ¨æŠ–éŸ³ä¸Šç‚¹èµäº†å¥½å¤šè§†é¢‘ï¼Œä¸ªäººä¸»é¡µä¸­å–œæ¬¢æœ‰å°†è¿‘ 1 åƒä¸ªï¼Œä¸å¤ªå–œæ¬¢ï¼Œæƒ³å½“ä¸€ä¸ªæ–°å·æ¥ä½¿ç”¨çš„è¯ï¼Œå¿…é¡»å°†è¿™äº›å–œæ¬¢å–æ¶ˆæ‰ã€‚&lt;/p&gt;
&lt;p&gt;æ‰‹åŠ¨å–æ¶ˆçš„è¯ï¼Œæ„Ÿè§‰ç‰¹åˆ«éº»çƒ¦ï¼Œè®¨åŒé‡å¤æ€§çš„åŠ¨ä½œã€‚ç½‘ä¸Šæœäº†ä¸€åœˆï¼ŒåŸºæœ¬æ²¡æ‰¾åˆ°è‡ªåŠ¨å–æ¶ˆçš„æ–¹æ¡ˆï¼Œå®åœ¨æ˜¯æ²¡æ’¤äº†ï¼Œä½œä¸ºä¸€ä¸ªå¼€å‘è€…ï¼Œæœ€ååªèƒ½è‡ªå·±åŠ¨æ‰‹ä¸°è¡£è¶³é£Ÿäº†ã€‚&lt;/p&gt;
&lt;p&gt;åˆæ­¥ä¸€æƒ³ï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;æ‰¾åˆ°æŠ–éŸ³çš„è¯·æ±‚æ¥å£ï¼Œæ‰¹é‡å¾ªç¯ä¸€éã€‚&lt;/li&gt;
&lt;li&gt;åœ¨æ‰‹æœºä¸Šæ¨¡æ‹Ÿç‚¹å‡»æ“ä½œã€‚&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://wangpeiyuan.cn/categories/Android/"/>
    
    
      <category term="APP" scheme="http://wangpeiyuan.cn/tags/APP/"/>
    
  </entry>
  
  <entry>
    <title>Jenkins åœ¨ Windows 10 ä¸‹ç¼–è¯‘ Android é¡¹ç›®æŠ¥é”™ï¼šAAPT2 Dameon startup failed</title>
    <link href="http://wangpeiyuan.cn/2020/04/02/Jenkins-compiles-Android-on-window-with-AAPT2-Dameon-startup-failed/"/>
    <id>http://wangpeiyuan.cn/2020/04/02/Jenkins-compiles-Android-on-window-with-AAPT2-Dameon-startup-failed/</id>
    <published>2020-04-02T01:57:12.000Z</published>
    <updated>2020-04-02T02:41:13.950Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨ Windows 10 ä¸‹æ­äº† Jenkins ç”¨æ¥åšæŒç»­æ€§é›†æˆï¼Œä¹‹å‰éƒ½æ˜¯ç”¨çš„ Macï¼Œå¥½å‡ å¹´éƒ½æ²¡ç¢°è¿‡ Windows äº†ï¼Œä¸è¿‡å‰é¢å®‰è£…è¿‡ç¨‹éƒ½é¡ºé£é¡ºæ°´çš„ï¼Œä¸€è·¯é…ç½®ä¸‹æ¥éƒ½æ²¡é‡åˆ°ä»€ä¹ˆé—®é¢˜ã€‚ä½†æœ€ç»ˆåœ¨ç¼–è¯‘ Android é¡¹ç›®çš„æ—¶å€™å‡ºç°äº†é—®é¢˜ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.gradle.api.tasks.TaskExecutionException: Execution failed <span class="keyword">for</span> task <span class="string">':app:mergeDebugResources'</span>.</span><br><span class="line">at org.gradle.api.<span class="built_in">int</span>ernal.tasks.execution.ExecuteActionsTaskExecuter$<span class="number">3.</span>accept(ExecuteActionsTaskExecuter.java:<span class="number">151</span>)</span><br><span class="line">at org.gradle.api.<span class="built_in">int</span>ernal.tasks.execution.ExecuteActionsTaskExecuter$<span class="number">3.</span>accept(ExecuteActionsTaskExecuter.java:<span class="number">148</span>)</span><br><span class="line">at org.gradle.<span class="built_in">int</span>ernal.Try$Failure.ifSuccessfulOrElse(Try.java:<span class="number">191</span>)</span><br><span class="line">  ...</span><br><span class="line">Caused by: com.android.builder.<span class="built_in">int</span>ernal.aapt.v2.Aapt2InternalException: AAPT2 aapt2<span class="number">-3.5</span><span class="number">.0</span><span class="number">-5435860</span>-windows Daemon #<span class="number">0</span>: Daemon startup failed</span><br><span class="line">This should <span class="keyword">not</span> happen under normal circumstances, please file an issue <span class="keyword">if</span> it does.</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure><a id="more"></a><p>å½“ç„¶é”™è¯¯ä¿¡æ¯ä¸æ­¢è¿™äº›ï¼Œåšäº†ç²¾ç®€ã€‚</p><p>èµ„æºåˆå¹¶å¤±è´¥ï¼Œæœ‰ç‚¹æ‡µï¼ŒMac ä¸Šè¿è¡Œçš„å¥½å¥½çš„é¡¹ç›®ï¼Œæ€ä¹ˆä¸€åˆ°è¿™å°±ä¸è¡Œäº†ã€‚ç„¶åå°±åœ¨ Windows ä¸Šæ‰“å¼€ Android Studio ç¼–è¯‘è¯•äº†ä¸€ä¸‹ï¼Œæ²¡é—®é¢˜å•Šã€‚ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯ä¸æ˜¯ Jenkins ä¸Šçš„é…ç½®å“ªé‡Œå°‘äº†ï¼Œä¸€ä¸ªä¸ªæ£€æŸ¥è¿‡å»ï¼Œæ²¡å‘ç°é—®é¢˜ã€‚é‡æ–°ç¼–è¯‘ä¸€æ¬¡ï¼ŒåŒæ ·å‡ºé”™ã€‚</p><p>æ²¡åŠæ³•äº†ï¼Œæ±‚åŠ© Googleï¼Œæœå‡ºäº†ä¸€å †ç¦ç”¨ AAPT2 çš„ï¼Œä½†ä»”ç»†ä¸€çœ‹éƒ½æ˜¯ AS å‡çº§å¯¼è‡´çš„ï¼Œæ ¹æœ¬ä¸é€‚åˆï¼Œè¿˜æœ‰æ˜¯å°† gradle çš„ç‰ˆæœ¬é™çº§ï¼Œè¿™ä¸ªè¿˜æœ‰ç‚¹å¯èƒ½æ€§ï¼Œæˆ‘å°±è¯•äº†ä¸€ä¸‹ï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œå‡ ä¹æŠŠæœç´¢å‡ºæ¥çš„å‡ é¡µç»“æœä¸€ä¸ªä¸ªç¿»å®Œäº†ï¼Œè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œè¿™ä¸‹å½»åº•æ²¡æ’¤äº†ã€‚</p><p>æ— å¥ˆï¼Œåªèƒ½å›è¿‡å¤´æ¥çœ‹çœ‹ç›¸å…³æŠ¥é”™ï¼Œä½¿ç”¨ <code>build --stackTrace --info</code> é‡æ–°ç¼–è¯‘ä¸€æ¬¡ï¼Œè·å–æ›´å¤šçš„è¯¦ç»†ä¿¡æ¯ã€‚ç„¶ååœ¨æŠ¥é”™å‰åä»”ç»†å¯»æ‰¾å‡ºé”™çš„è››ä¸é©¬è¿¹äº†ã€‚</p><p>ç»ˆäºï¼Œè¿˜æ˜¯è®©æˆ‘å‘ç°äº†é—®é¢˜ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Transforming</span> <span class="selector-tag">artifact</span> <span class="selector-tag">aapt2-windows</span><span class="selector-class">.jar</span> (<span class="selector-tag">com</span><span class="selector-class">.android</span><span class="selector-class">.tools</span><span class="selector-class">.build</span><span class="selector-pseudo">:aapt2</span><span class="selector-pseudo">:3.5.1-5435860)</span> <span class="selector-tag">with</span> <span class="selector-tag">Aapt2Extractor</span></span><br><span class="line"><span class="selector-tag">Caching</span> <span class="selector-tag">disabled</span> <span class="selector-tag">for</span> <span class="selector-tag">Aapt2Extractor</span>: <span class="selector-tag">C</span>:\<span class="selector-tag">Windows</span>\<span class="selector-tag">System32</span>\<span class="selector-tag">config</span>\<span class="selector-tag">systemprofile</span>\<span class="selector-class">.gradle</span>\<span class="selector-tag">caches</span>\<span class="selector-tag">modules-2</span>\<span class="selector-tag">files-2</span><span class="selector-class">.1</span>\<span class="selector-tag">com</span><span class="selector-class">.android</span><span class="selector-class">.tools</span><span class="selector-class">.build</span>\<span class="selector-tag">aapt2</span>\3<span class="selector-class">.5</span><span class="selector-class">.1-5435860</span>\<span class="selector-tag">ba4bab716d8d80e597b7baeec7df1bcf63562099</span>\<span class="selector-tag">aapt2-3</span><span class="selector-class">.5</span><span class="selector-class">.1-5435860-windows</span><span class="selector-class">.jar</span> <span class="selector-tag">because</span>:</span><br><span class="line">  <span class="selector-tag">Build</span> <span class="selector-tag">cache</span> <span class="selector-tag">is</span> <span class="selector-tag">disabled</span></span><br><span class="line"><span class="selector-tag">Skipping</span> <span class="selector-tag">Aapt2Extractor</span>: <span class="selector-tag">C</span>:\<span class="selector-tag">Windows</span>\<span class="selector-tag">System32</span>\<span class="selector-tag">config</span>\<span class="selector-tag">systemprofile</span>\<span class="selector-class">.gradle</span>\<span class="selector-tag">caches</span>\<span class="selector-tag">modules-2</span>\<span class="selector-tag">files-2</span><span class="selector-class">.1</span>\<span class="selector-tag">com</span><span class="selector-class">.android</span><span class="selector-class">.tools</span><span class="selector-class">.build</span>\<span class="selector-tag">aapt2</span>\3<span class="selector-class">.5</span><span class="selector-class">.1-5435860</span>\<span class="selector-tag">ba4bab716d8d80e597b7baeec7df1bcf63562099</span>\<span class="selector-tag">aapt2-3</span><span class="selector-class">.5</span><span class="selector-class">.1-5435860-windows</span><span class="selector-class">.jar</span> <span class="selector-tag">as</span> <span class="selector-tag">it</span> <span class="selector-tag">is</span> <span class="selector-tag">up-to-date</span>.</span><br><span class="line"><span class="selector-tag">AAPT2</span> <span class="selector-tag">aapt2-3</span><span class="selector-class">.5</span><span class="selector-class">.1-5435860-windows</span> <span class="selector-tag">Daemon</span> <span class="selector-id">#0</span>: <span class="selector-tag">starting</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ä»”ç»†çœ‹ï¼Œä¼šå‘ç° gradle çš„ç¼“å­˜ç«Ÿç„¶æ˜¯åœ¨ <code>Windows\System32\config</code> ç›®å½•ä¸‹ï¼Œæƒ³æƒ³å°±è§‰å¾—ä¸å¯æ€è®®ï¼Œæ€ä¹ˆä¼šè·‘åˆ°ç³»ç»Ÿç›®å½•ä¸‹å»ï¼Œè¿™ä¹ˆä¸€çœ‹å°±åº”è¯¥æ˜¯æƒé™é—®é¢˜äº†ï¼Œæœäº†ä¸€ä¸‹ï¼ŒWindows çš„æˆæƒå¥½éº»çƒ¦ï¼Œæ”¾å¼ƒã€‚</p><p>å¦‚æœä¸æˆæƒï¼Œé‚£åªèƒ½è½¬ç§»ç¼“å­˜ç›®å½•äº†ï¼Œä»¥ Windows ä¿®æ”¹ gradle ç¼“å­˜ç›®å½•ä¸ºå…³é”®å­—æœç´¢ï¼Œæœç„¶æœç´¢åˆ°äº†ï¼šé…ç½® GRADLE_USER_HOME ç¯å¢ƒå˜é‡å°±è¡Œï¼Œå€¼çš„è¯è‡ªå·±æ–°å»ºä¸ªç›®å½•å°±è¡Œï¼ˆæœ€å¥½ä¸è¦åœ¨ç³»ç»Ÿç›˜ï¼‰ï¼Œé‡å¯ Jenkins å†æ¬¡ç¼–è¯‘ï¼ŒæˆåŠŸã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘åœ¨ Windows 10 ä¸‹æ­äº† Jenkins ç”¨æ¥åšæŒç»­æ€§é›†æˆï¼Œä¹‹å‰éƒ½æ˜¯ç”¨çš„ Macï¼Œå¥½å‡ å¹´éƒ½æ²¡ç¢°è¿‡ Windows äº†ï¼Œä¸è¿‡å‰é¢å®‰è£…è¿‡ç¨‹éƒ½é¡ºé£é¡ºæ°´çš„ï¼Œä¸€è·¯é…ç½®ä¸‹æ¥éƒ½æ²¡é‡åˆ°ä»€ä¹ˆé—®é¢˜ã€‚ä½†æœ€ç»ˆåœ¨ç¼–è¯‘ Android é¡¹ç›®çš„æ—¶å€™å‡ºç°äº†é—®é¢˜ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;figure class=&quot;highlight angelscript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;org.gradle.api.tasks.TaskExecutionException: Execution failed &lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; task &lt;span class=&quot;string&quot;&gt;&#39;:app:mergeDebugResources&#39;&lt;/span&gt;.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	at org.gradle.api.&lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt;ernal.tasks.execution.ExecuteActionsTaskExecuter$&lt;span class=&quot;number&quot;&gt;3.&lt;/span&gt;accept(ExecuteActionsTaskExecuter.java:&lt;span class=&quot;number&quot;&gt;151&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	at org.gradle.api.&lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt;ernal.tasks.execution.ExecuteActionsTaskExecuter$&lt;span class=&quot;number&quot;&gt;3.&lt;/span&gt;accept(ExecuteActionsTaskExecuter.java:&lt;span class=&quot;number&quot;&gt;148&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	at org.gradle.&lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt;ernal.Try$Failure.ifSuccessfulOrElse(Try.java:&lt;span class=&quot;number&quot;&gt;191&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Caused by: com.android.builder.&lt;span class=&quot;built_in&quot;&gt;int&lt;/span&gt;ernal.aapt.v2.Aapt2InternalException: AAPT2 aapt2&lt;span class=&quot;number&quot;&gt;-3.5&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.0&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;-5435860&lt;/span&gt;-windows Daemon #&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;: Daemon startup failed&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;This should &lt;span class=&quot;keyword&quot;&gt;not&lt;/span&gt; happen under normal circumstances, please file an issue &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; it does.&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt; ...&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Jenkins" scheme="http://wangpeiyuan.cn/categories/Jenkins/"/>
    
    
      <category term="Tip" scheme="http://wangpeiyuan.cn/tags/Tip/"/>
    
  </entry>
  
  <entry>
    <title>Butterknife æºç æµ…æ</title>
    <link href="http://wangpeiyuan.cn/2020/01/21/ButterKnife-source-code-analysis/"/>
    <id>http://wangpeiyuan.cn/2020/01/21/ButterKnife-source-code-analysis/</id>
    <published>2020-01-21T10:07:28.000Z</published>
    <updated>2020-04-02T02:40:49.279Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h2><p>Butterknife ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œç®€åŒ–æ‰‹åŠ¨ä¹¦å†™ <code>findViewById</code> ç­‰ç­‰ï¼Œè¿™é‡Œæˆ‘ä»¬å°†æ·±å…¥æºç æ¥çœ‹çœ‹ Butterknife å†…éƒ¨çš„å®ç°åŸç†ã€‚</p><a id="more"></a><h2 id="äºŒã€åŸºæœ¬ç”¨æ³•"><a href="#äºŒã€åŸºæœ¬ç”¨æ³•" class="headerlink" title="äºŒã€åŸºæœ¬ç”¨æ³•"></a>äºŒã€åŸºæœ¬ç”¨æ³•</h2><p>é¦–å…ˆï¼Œå†å¤ä¹ ä¸€ä¸‹åŸºæœ¬çš„ç”¨æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class MainActivity : AppCompatActivity() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BindView</span>(R.id.btn_jetpack) <span class="comment">//2</span></span><br><span class="line">    lateinit <span class="keyword">var</span> btnJetPack: Button</span><br><span class="line"></span><br><span class="line">    <span class="function">override fun <span class="title">onCreate</span><span class="params">(savedInstanceState: Bundle?)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        ButterKnife.bind(<span class="keyword">this</span>) <span class="comment">//1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œç”¨ <code>@BindView</code> æ³¨è§£æ›¿ä»£äº† <code>findViewById</code>ï¼Œå½“ç„¶è¿˜æœ‰å…¶ä»–çš„ç”¨æ³•ï¼Œæ¯”å¦‚ <code>@OnClick</code> æ³¨è§£æ›¿ä»£ <code>setOnClickListener()</code> ç­‰ç­‰ï¼Œä½†å…¶å†…éƒ¨åŸç†åŸºæœ¬ä¸€è‡´ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä»…å¯¹ <code>@BindView</code>  çš„å†…éƒ¨å®ç°æ¥è§£æ Butterknife çš„å®ç°ã€‚</p><p>çœ‹åˆ°è¿™é‡Œï¼Œä½ å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼Œæ³¨è§£æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆé€šè¿‡ä¸€ä¸ªç®€å•çš„æ³¨è§£å°±èƒ½æ›¿ä»£ç®€åŒ–ä»£ç å‘¢ï¼Ÿ</p><p>åœ¨è¿›å…¥æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å¾—å…ˆäº†è§£ä¸€ä¸‹æ³¨è§£ã€‚</p><p>é¦–å…ˆï¼Œå¾—å…ˆçŸ¥é“ APT(Annotation Processing Tool) æ³¨è§£å¤„ç†å·¥å…·ï¼Œç½‘ä¸Šå…¶å®æœ‰å¾ˆå¤šæ•™ç¨‹ä¹‹ç±»çš„ï¼Œæˆ‘ä»¬è¿™é‡Œä¾¿ä¸å†æ·±å…¥ï¼Œç®€å•çš„äº†è§£ä¸€ä¸‹ APT çš„å®ç°æ­¥éª¤ä»¥åŠå…¶ä½œç”¨æ—¶æœºã€‚</p><ul><li>å…ˆå£°æ˜ä¸€ä¸ªæ³¨è§£ <code>@interface</code>ï¼Œå®šä¹‰æ³¨è§£çš„ç”Ÿå‘½å‘¨æœŸ <code>@Retention</code> å’Œä½œç”¨åŒºåŸŸ <code>@Target</code>ï¼›</li><li>ç„¶åå®šä¹‰ä¸€ä¸ªæ³¨è§£å¤„ç†å™¨ï¼Œç»§æ‰¿å¹¶å®ç° <code>AbstractProcessor</code> ä¸­çš„æ–¹æ³•ï¼›</li><li>æœ€åï¼Œä»£ç åœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨ä¼šæ‰«ææ‰€æœ‰å¸¦æ³¨è§£çš„ç±»ï¼Œé€šè¿‡å®šä¹‰çš„æ³¨è§£å¤„ç†å™¨æ¥ç”Ÿæˆç›¸åº”çš„æ¨¡æ¿ Java ç±»ã€‚</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°†è¿›å…¥ Butterknife çš„æºç ä¸–ç•Œã€‚</p><h2 id="ä¸‰ã€æºç æµ…æ"><a href="#ä¸‰ã€æºç æµ…æ" class="headerlink" title="ä¸‰ã€æºç æµ…æ"></a>ä¸‰ã€æºç æµ…æ</h2><h3 id="3-1-Butterknife-bind"><a href="#3-1-Butterknife-bind" class="headerlink" title="3.1 Butterknife.bind()"></a>3.1 Butterknife.bind()</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ <code>ButterKnife.bind(this)</code> è¿™é‡Œé¢åˆ°åº•åšäº†ä»€ä¹ˆå¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ButterKnife.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull Activity target)</span> </span>&#123;</span><br><span class="line">    View sourceView = target.getWindow().getDecorView();</span><br><span class="line">    <span class="keyword">return</span> bind(target, sourceView);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unbinder <span class="title">bind</span><span class="params">(@NonNull Object target, @NonNull View source)</span> </span>&#123;</span><br><span class="line">  Class&lt;?&gt; targetClass = target.getClass();</span><br><span class="line"></span><br><span class="line">  Constructor&lt;? extends Unbinder&gt; constructor = findBindingConstructorForClass(targetClass);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (constructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> Unbinder.EMPTY;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//noinspection TryWithIdenticalCatches Resolves to API 19+ only type.</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> constructor.newInstance(target, source);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç æ¸…æ™°ç®€å•ï¼Œä¸»è¦æ˜¯æ‰¾åˆ°ç›®æ ‡ç±»çš„æ„é€ å™¨ <code>constructor</code> ï¼Œç„¶åé€šè¿‡åå°„çš„æ–¹å¼å®ä¾‹åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ButterKnife.java</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Constructor&lt;? extends Unbinder&gt;&gt; BINDINGS = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Constructor&lt;? extends Unbinder&gt; findBindingConstructorForClass(Class&lt;?&gt; cls) &#123;</span><br><span class="line">  Constructor&lt;? extends Unbinder&gt; bindingCtor = BINDINGS.get(cls);</span><br><span class="line">  <span class="keyword">if</span> (bindingCtor != <span class="keyword">null</span> || BINDINGS.containsKey(cls)) &#123;</span><br><span class="line">    <span class="keyword">return</span> bindingCtor;</span><br><span class="line">  &#125;</span><br><span class="line">  String clsName = cls.getName();</span><br><span class="line">  <span class="keyword">if</span> (clsName.startsWith(<span class="string">"android."</span>) || clsName.startsWith(<span class="string">"java."</span>)</span><br><span class="line">      || clsName.startsWith(<span class="string">"androidx."</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Class&lt;?&gt; bindingClass = cls.getClassLoader().loadClass(clsName + <span class="string">"_ViewBinding"</span>);</span><br><span class="line">    <span class="comment">//noinspection unchecked</span></span><br><span class="line">    bindingCtor = (Constructor&lt;? extends Unbinder&gt;) bindingClass.getConstructor(cls, View<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">    bindingCtor = findBindingConstructorForClass(cls.getSuperclass());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Unable to find binding constructor for "</span> + clsName, e);</span><br><span class="line">  &#125;</span><br><span class="line">  BINDINGS.put(cls, bindingCtor);</span><br><span class="line">  <span class="keyword">return</span> bindingCtor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œä½¿ç”¨äº† <code>LinkedHashMap</code> ä½œä¸ºç¼“å­˜ï¼Œé¿å…æ¯æ¬¡é‡æ–°åŠ è½½ã€‚ç„¶åè¿‡æ»¤äº†ç³»ç»Ÿç›¸å…³ç±»ï¼Œå¦‚æœæ˜¯ <code>android.</code>ã€ <code>java.</code> ã€<code>androidx.</code> å¼€å¤´çš„ä¸ä½œå¤„ç†ã€‚æœ€åé€šè¿‡ç±»åŠ è½½å™¨åŠ è½½å¯¹åº”çš„ <code>_ViewBinding</code> ç±»ï¼Œæ¯”å¦‚è¿™è¾¹çš„ä¾‹å­ä¸­åº”è¯¥æ˜¯ <code>MainActivity_ViewBinding</code> ç±»ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±ä¼šäº§ç”Ÿä¸€äº›ç–‘é—®ï¼Œæˆ‘ä»¬åœ¨ä¾‹å­é‡Œéƒ½æ²¡å†™è¿‡ <code>MainActivity_ViewBinding</code> è¿™ä¸ªç±»ï¼Œé‚£å®ƒä»å“ªé‡Œç”Ÿæˆçš„å‘¢ï¼Ÿåˆæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</p><p>åœ¨ AS ä¸­æœç´¢ä¸€ä¸‹ï¼Œå¯ä»¥å‘ç°åœ¨ <code>/app/build/generated/source/kapt/debug/åŒ…å/</code> ç›®å½•ä¸‹æ‰¾åˆ°äº†æ­¤ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity_ViewBinding</span> <span class="keyword">implements</span> <span class="title">Unbinder</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> MainActivity target;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UiThread</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MainActivity_ViewBinding</span><span class="params">(MainActivity target)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(target, target.getWindow().getDecorView());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UiThread</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MainActivity_ViewBinding</span><span class="params">(MainActivity target, View source)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.target = target;</span><br><span class="line"></span><br><span class="line">    target.btnJetPack = Utils.findRequiredViewAsType(source, R.id.btn_jetpack, <span class="string">"field 'btnJetPack'"</span>, Button<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MainActivity target = <span class="keyword">this</span>.target;</span><br><span class="line">    <span class="keyword">if</span> (target == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Bindings already cleared."</span>);</span><br><span class="line">    <span class="keyword">this</span>.target = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    target.btnJetPack = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ä»£ç éå¸¸ç®€å•ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­å¯»æ‰¾å¯¹åº”çš„æ§ä»¶ã€‚è¿™è¾¹æœ‰ä¸€ç‚¹ç¨å¾®æ³¨æ„ä¸€ä¸‹ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ Butterknife çš„æ—¶å€™ï¼Œæ§ä»¶çš„ä¿®é¥°ç¬¦ä¸èƒ½ä¸º <code>private</code> çš„åŸå› å°±åœ¨è¿™é‡Œï¼Œæ˜¯ç›´æ¥èµ‹å€¼è€Œä¸æ˜¯é€šè¿‡ set æ–¹å¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Utils.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">findRequiredViewAsType</span><span class="params">(View source, @IdRes <span class="keyword">int</span> id, String who,</span></span></span><br><span class="line"><span class="function"><span class="params">    Class&lt;T&gt; cls)</span> </span>&#123;</span><br><span class="line">  View view = findRequiredView(source, id, who);</span><br><span class="line">  <span class="keyword">return</span> castView(view, id, who, cls);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> View <span class="title">findRequiredView</span><span class="params">(View source, @IdRes <span class="keyword">int</span> id, String who)</span> </span>&#123;</span><br><span class="line">  View view = source.findViewById(id);</span><br><span class="line">  <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> view;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">castView</span><span class="params">(View view, @IdRes <span class="keyword">int</span> id, String who, Class&lt;T&gt; cls)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> cls.cast(view);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆä¹Ÿæ˜¯é€šè¿‡ <code>findViewById</code> æ¥å¯»æ‰¾æ§ä»¶ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ç”Ÿæˆçš„ä»¥ <code>_ViewBinding</code> ç»“å°¾çš„ç±»ä¸»è¦æ˜¯ç”¨æ¥å¯»æ‰¾è¢« <code>@BindView</code> æ³¨è§£æ ‡è¯†çš„æ§ä»¶ã€‚é‚£ä¹ˆè¯¥ç±»æ˜¯åœ¨å“ªé‡Œç”Ÿæˆçš„å‘¢ï¼Ÿ</p><h3 id="3-2-ButterKnifeProcessor"><a href="#3-2-ButterKnifeProcessor" class="headerlink" title="3.2 ButterKnifeProcessor"></a>3.2 ButterKnifeProcessor</h3><p>åœ¨å‰é¢ï¼Œæˆ‘ä»¬è¯´è¿‡ APT éœ€è¦å£°æ˜ä¸€ä¸ªæ³¨è§£ä»¥åŠä¸€ä¸ªæ³¨è§£å¤„ç†å™¨ï¼Œä»¥ä¾¿ç¼–è¯‘å™¨åœ¨ç¼–è¯‘çš„æ—¶å€™ä½œç›¸åº”çš„å¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RUNTIME) <span class="meta">@Target</span>(FIELD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> BindView &#123;</span><br><span class="line">  <span class="comment">/** View ID to which the field will be bound. */</span></span><br><span class="line">  <span class="meta">@IdRes</span> <span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å£°æ˜äº†ä¸€ä¸ª <code>BindView</code> çš„æ³¨è§£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ButterKnifeProcessor.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; elements, RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">  Map&lt;TypeElement, BindingSet&gt; bindingMap = findAndParseTargets(env);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Map.Entry&lt;TypeElement, BindingSet&gt; entry : bindingMap.entrySet()) &#123;</span><br><span class="line">    TypeElement typeElement = entry.getKey();</span><br><span class="line">    BindingSet binding = entry.getValue();</span><br><span class="line"></span><br><span class="line">    JavaFile javaFile = binding.brewJava(sdk, debuggable);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      javaFile.writeTo(filer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;TypeElement, BindingSet&gt; <span class="title">findAndParseTargets</span><span class="params">(RoundEnvironment env)</span> </span>&#123;</span><br><span class="line">  Map&lt;TypeElement, BindingSet.Builder&gt; builderMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">  Set&lt;TypeElement&gt; erasedTargetNames = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Process each @BindView element.</span></span><br><span class="line">  <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(BindView<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">    <span class="comment">// we don't SuperficialValidation.validateElement(element)</span></span><br><span class="line">    <span class="comment">// so that an unresolved View type can be generated by later processing rounds</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      parseBindView(element, builderMap, erasedTargetNames);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      logParsingError(element, BindView<span class="class">.<span class="keyword">class</span>, <span class="title">e</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bindingMap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBindView</span><span class="params">(Element element, Map&lt;TypeElement, BindingSet.Builder&gt; builderMap,</span></span></span><br><span class="line"><span class="function"><span class="params">    Set&lt;TypeElement&gt; erasedTargetNames)</span> </span>&#123;</span><br><span class="line">  TypeElement enclosingElement = (TypeElement) element.getEnclosingElement();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Assemble information on the field.</span></span><br><span class="line">  <span class="keyword">int</span> id = element.getAnnotation(BindView<span class="class">.<span class="keyword">class</span>).<span class="title">value</span>()</span>;</span><br><span class="line">  BindingSet.Builder builder = builderMap.get(enclosingElement);</span><br><span class="line">  Id resourceId = elementToId(element, BindView<span class="class">.<span class="keyword">class</span>, <span class="title">id</span>)</span>;</span><br><span class="line">  <span class="keyword">if</span> (builder != <span class="keyword">null</span>) &#123;</span><br><span class="line">    String existingBindingName = builder.findExistingBindingName(resourceId);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    builder = getOrCreateBindingBuilder(builderMap, enclosingElement);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  String name = simpleName.toString();</span><br><span class="line">  TypeName type = TypeName.get(elementType);</span><br><span class="line">  <span class="keyword">boolean</span> required = isFieldRequired(element);</span><br><span class="line"></span><br><span class="line">  builder.addField(resourceId, <span class="keyword">new</span> FieldViewBinding(name, type, required));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add the type-erased version to the valid binding targets set.</span></span><br><span class="line">  erasedTargetNames.add(enclosingElement);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> BindingSet.<span class="function">Builder <span class="title">getOrCreateBindingBuilder</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Map&lt;TypeElement, BindingSet.Builder&gt; builderMap, TypeElement enclosingElement)</span> </span>&#123;</span><br><span class="line">  BindingSet.Builder builder = builderMap.get(enclosingElement);</span><br><span class="line">  <span class="keyword">if</span> (builder == <span class="keyword">null</span>) &#123;</span><br><span class="line">    builder = BindingSet.newBuilder(enclosingElement);</span><br><span class="line">    builderMap.put(enclosingElement, builder);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> builder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ButterKnifeProcessor</code> çš„ä»£ç è¿™é‡Œç²¾ç®€äº†å¾ˆå¤šï¼ŒæŠ“ä¸»æµç¨‹å°±å¥½ï¼Œæ›´å¤šçš„ç»†èŠ‚å¦‚æœæœ‰å…´è¶£å¯ä»¥è‡ªå·±è·Ÿä¸‹æºç ã€‚åœ¨ <code>process()</code> æ–¹æ³•ä¸­ï¼Œä¸»è¦æ˜¯å¯»æ‰¾è¢«  <code>BindView</code> æ³¨è§£æ ‡è¯†çš„ç±»å­˜åˆ°é›†åˆä¸­ï¼Œæœ€åå¾ªç¯å–å‡ºé€šè¿‡ <code>javapoet</code> ç”Ÿæˆ <code>_ViewBinding</code>  æ¨¡æ¿ä»£ç ç±»ã€‚</p><h2 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h2><p>é€šè¿‡ä¸Šé¢çš„ç®€å•çš„æºç è§£æï¼Œæˆ‘ä»¬å¤§æ¦‚æ¸…æ¥šäº† Butterknife çš„å®ç°åŸç†ã€‚å½“ç„¶ Butterknife å¹¶ä¸ä»…ä»…è¿™ä¹ˆç®€å•ï¼Œè¿˜æœ‰å…¶ä»–çš„åŠŸèƒ½ï¼Œä½†åŸç†æ˜¯ä¸€æ ·çš„ã€‚</p><p>æœ€åï¼Œæˆ‘ä»¬ç®€å•åšä¸ªæ€»ç»“ï¼š</p><ol><li>é¦–å…ˆï¼Œåœ¨ç¼–è¯‘æœŸé—´æ‰«æå£°æ˜çš„æ³¨è§£ï¼ˆå¦‚ <code>BindView</code> ï¼‰ï¼Œé€šè¿‡ <code>ButterKnifeProcessor</code> æ³¨è§£å¤„ç†å™¨ç›¸åº”çš„è§£æä»¥åŠè°ƒç”¨ <code>Javapoet</code> åº“ç”Ÿæˆ <code>_ViewBinding</code> æ¨¡æ¿ä»£ç ã€‚</li><li>ç„¶åï¼Œåœ¨æˆ‘ä»¬è°ƒç”¨ <code>ButterKnife.bind(this)</code> æ–¹æ³•çš„æ—¶å€™ï¼Œé€šè¿‡ç±»åŠ è½½å™¨åŠ è½½æŒ‡å®šçš„ç±»ï¼ˆå¦‚ <code>MainActivity_ViewBinding</code> ï¼‰ï¼Œå¹¶é€šè¿‡åå°„æ–¹å¼å®ä¾‹åŒ–è¯¥æ¨¡æ¿ç±»ï¼Œä»è€Œå®ç°äº†å¯¹æ ‡è¯†æ³¨è§£çš„æ§ä»¶èµ‹å€¼ã€‚</li></ol><h2 id="äº”ã€å‚è€ƒä¸æ¨è"><a href="#äº”ã€å‚è€ƒä¸æ¨è" class="headerlink" title="äº”ã€å‚è€ƒä¸æ¨è"></a>äº”ã€å‚è€ƒä¸æ¨è</h2><ol><li><a href="https://github.com/JakeWharton/butterknife/" target="_blank" rel="noopener">ButterKnife</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ä¸€ã€å‰è¨€&quot;&gt;&lt;a href=&quot;#ä¸€ã€å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€å‰è¨€&quot;&gt;&lt;/a&gt;ä¸€ã€å‰è¨€&lt;/h2&gt;&lt;p&gt;Butterknife ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œç®€åŒ–æ‰‹åŠ¨ä¹¦å†™ &lt;code&gt;findViewById&lt;/code&gt; ç­‰ç­‰ï¼Œè¿™é‡Œæˆ‘ä»¬å°†æ·±å…¥æºç æ¥çœ‹çœ‹ Butterknife å†…éƒ¨çš„å®ç°åŸç†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://wangpeiyuan.cn/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>EventBus æºç æµ…æ</title>
    <link href="http://wangpeiyuan.cn/2019/12/21/EventBus-source-code-analysis/"/>
    <id>http://wangpeiyuan.cn/2019/12/21/EventBus-source-code-analysis/</id>
    <published>2019-12-21T14:35:52.000Z</published>
    <updated>2019-12-21T14:38:28.685Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h2><p>EventBus ç›¸ä¿¡å¤§å®¶å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œä¸€ä¸ªå‘å¸ƒ/è®¢é˜…äº‹ä»¶çš„å¤„ç†åº“ã€‚</p><p>æˆ‘ä»¬è¿™é‡Œå°†ä¼šä»ä½¿ç”¨åˆ°åŸç†æ¥è¿›ä¸€æ­¥ç†è§£ EventBus ã€‚</p><a id="more"></a><h2 id="äºŒã€EventBus-çš„ä½¿ç”¨"><a href="#äºŒã€EventBus-çš„ä½¿ç”¨" class="headerlink" title="äºŒã€EventBus çš„ä½¿ç”¨"></a>äºŒã€EventBus çš„ä½¿ç”¨</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹ EventBus çš„ä½¿ç”¨ï¼Œä¸€å…±ä¸‰ä¸ªæ­¥éª¤ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼šå®šä¹‰äº‹ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageEvent</span> </span>&#123;</span><br><span class="line">    <span class="comment">//æ·»åŠ æ‰€éœ€çš„å±æ€§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥ï¼šåœ¨éœ€è¦æ¥æ”¶äº‹ä»¶çš„åœ°æ–¹ï¼Œå³è®¢é˜…è€…ï¼Œå®šä¹‰æ¥æ”¶æ–¹æ³•ä»¥åŠæ³¨å†Œè®¢é˜…è€…ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰æ¥æ”¶æ–¹æ³•</span></span><br><span class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN, priority = <span class="number">1</span>)</span><br><span class="line"><span class="function">fun <span class="title">onMessageEvent</span><span class="params">(messageEvent: MessageEvent)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//do something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Subscribe</span>(threadMode = ThreadMode.MAIN, priority = <span class="number">1</span>, sticky = <span class="keyword">true</span>)</span><br><span class="line"><span class="function">fun <span class="title">onStickyMessageEvent</span><span class="params">(messageEvent: MessageEvent)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//do something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ³¨å†Œè®¢é˜…è€…</span></span><br><span class="line"><span class="function">override fun <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onStart()</span><br><span class="line">    EventBus.getDefault().register(<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">override fun <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onStop()</span><br><span class="line">    EventBus.getDefault().unregister(<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰æ­¥ï¼šå‘é€äº‹ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EventBus.getDefault().post(MessageEvent())</span><br><span class="line"><span class="comment">//å‘é€ç²˜æ€§äº‹ä»¶</span></span><br><span class="line">EventBus.getDefault().postSticky(MessageEvent())</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥æºç æ¥çœ‹çœ‹ä»¥ä¸Šçš„å‡ æ­¥æ“ä½œï¼Œå†…éƒ¨ç©¶ç«Ÿåšäº†ä»€ä¹ˆå¤„ç†æ¥å®ç°è®¢é˜…ä¸å‘å¸ƒçš„ã€‚</p><p>åˆ†æçš„é¡ºåºå¦‚ä¸‹ï¼š</p><ol><li><code>EventBus.getDefault().register(this)</code> å†…éƒ¨åšäº†å“ªäº›æ“ä½œï¼Ÿ</li><li><code>EventBus.getDefault().post(MessageEvent())</code> å’Œ <code>EventBus.getDefault().postSticky(MessageEvent())</code> å¦‚ä½•å‘é€äº‹ä»¶ï¼Ÿ</li><li><code>@Subscribe()...</code> æ¥æ”¶äº‹ä»¶çš„æ–¹æ³•æ˜¯å¦‚ä½•æ¥æ”¶åˆ°äº‹ä»¶çš„ï¼Ÿ</li><li><code>EventBus.getDefault().unregister(this)</code> åˆåšäº†å“ªäº›å¤„ç†ï¼Ÿ</li></ol><h2 id="ä¸‰ã€EventBus-æºç æµ…æ"><a href="#ä¸‰ã€EventBus-æºç æµ…æ" class="headerlink" title="ä¸‰ã€EventBus æºç æµ…æ"></a>ä¸‰ã€EventBus æºç æµ…æ</h2><blockquote><p>æ³¨ï¼šåŸºäº EventBus 3.1.1 ç‰ˆæœ¬è¿›è¡Œåˆ†æã€‚æ¶‰åŠçš„ä»£ç ä¼šåšç›¸åº”çš„ç®€åŒ–å¤„ç†ï¼Œåªä¿ç•™å…³é”®éƒ¨åˆ†ã€‚</p></blockquote><h3 id="3-1-æ³¨å†Œè®¢é˜…è€…-register"><a href="#3-1-æ³¨å†Œè®¢é˜…è€…-register" class="headerlink" title="3.1 æ³¨å†Œè®¢é˜…è€… register"></a>3.1 æ³¨å†Œè®¢é˜…è€… register</h3><p>é¦–å…ˆï¼Œ EventBus çš„å®ä¾‹æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EventBus.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> EventBus <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (EventBus<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (defaultInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                defaultInstance = <span class="keyword">new</span> EventBus();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> defaultInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼ŒEventBus çš„å®ä¾‹æ˜¯é€šè¿‡ <code>getDefault()</code> æ–¹æ³•å®ç°çš„ä¸€ä¸ªå•ä¾‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EventBus.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; subscriberClass = subscriber.getClass();</span><br><span class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = subscriberMethodFinder.findSubscriberMethods(subscriberClass);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (SubscriberMethod subscriberMethod : subscriberMethods) &#123;</span><br><span class="line">            subscribe(subscriber, subscriberMethod);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//SubscriberMethod.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubscriberMethod</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Method method;</span><br><span class="line">    <span class="keyword">final</span> ThreadMode threadMode;</span><br><span class="line">    <span class="keyword">final</span> Class&lt;?&gt; eventType;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> priority;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> sticky;</span><br><span class="line">    <span class="comment">/** Used for efficient comparison */</span></span><br><span class="line">    String methodString;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>æ³¨ï¼šä¸‹é¢å‡ºç°çš„è®¢é˜…è€…æŒ‡çš„æ˜¯ <code>Object subscriber</code> ï¼Œåœ¨å®é™…ä¸­å¯ä»¥æ˜¯ä¸€ä¸ª Activity ä¹‹ç±»çš„ã€‚è®¢é˜…æ–¹æ³•æŒ‡çš„æ˜¯ è¢« <code>@Subscribe</code> æ³¨è§£æ ‡è¯†çš„æ–¹æ³•ã€‚</strong></p></blockquote><p><code>register</code> æ–¹æ³•ä¸­çš„ä»£ç ä¸å¤šï¼Œä»è¿™æ®µä»£ç ä¸­å¯ä»¥å¤§æ¦‚çŸ¥é“å…ˆæ˜¯å¯»æ‰¾è®¢é˜…è€…ä¸­çš„æ‰€æœ‰è®¢é˜…æ–¹æ³•çš„é›†åˆï¼Œç„¶åå°†è¿™äº›æ–¹æ³•ä¸€ä¸€è®°å½•ä¸‹æ¥ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹æ˜¯å¦‚ä½•è·å–è®¢é˜…æ–¹æ³•é›†åˆçš„ï¼Œå¯ä»¥å…ˆå¤§æ¦‚çŒœæµ‹ä¸€ä¸‹ï¼Œå‚æ•°æ˜¯ä¸€ä¸ª Class å¤§æ¦‚ç‡æ˜¯é€šè¿‡åå°„æ–¹å¼è·å–çš„ï¼Œé‚£å¥½ï¼Œæˆ‘ä»¬è·Ÿè¿›ä»£ç çœ‹çœ‹æˆ‘ä»¬çŒœæµ‹æ˜¯å¦æ­£ç¡®ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubscriberMethodFinder.java</span></span><br><span class="line"><span class="function">List&lt;SubscriberMethod&gt; <span class="title">findSubscriberMethods</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</span><br><span class="line">    List&lt;SubscriberMethod&gt; subscriberMethods = METHOD_CACHE.get(subscriberClass);</span><br><span class="line">    <span class="keyword">if</span> (subscriberMethods != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> subscriberMethods;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ˜¯å¦å¼ºåˆ¶ä½¿ç”¨åå°„ï¼Œé»˜è®¤ false</span></span><br><span class="line">    <span class="keyword">if</span> (ignoreGeneratedIndex) &#123;</span><br><span class="line">        subscriberMethods = findUsingReflection(subscriberClass);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        subscriberMethods = findUsingInfo(subscriberClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (subscriberMethods.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Subscriber "</span> + subscriberClass</span><br><span class="line">                + <span class="string">" and its super classes have no public methods with the @Subscribe annotation"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        METHOD_CACHE.put(subscriberClass, subscriberMethods);</span><br><span class="line">        <span class="keyword">return</span> subscriberMethods;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬çŒœæµ‹ä½¿ç”¨äº†åå°„è¿™ä¸ªæ²¡é”™ï¼Œä½†ä¸å¤Ÿå®Œæ•´ï¼Œè¿™é‡Œé¢è¿˜å¯ä»¥ä½¿ç”¨å…¶ä»–çš„æ–¹å¼æ¥è·å–è®¢é˜…æ–¹æ³•çš„é›†åˆã€‚å…ˆæ¥çœ‹çœ‹è¿™ç§æ–¹å¼æ˜¯ä»€ä¹ˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubscriberMethodFinder.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingInfo</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</span><br><span class="line">    FindState findState = prepareFindState();</span><br><span class="line">    findState.initForSubscriber(subscriberClass);</span><br><span class="line">    <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">        findState.subscriberInfo = getSubscriberInfo(findState);</span><br><span class="line">        <span class="keyword">if</span> (findState.subscriberInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">            SubscriberMethod[] array = findState.subscriberInfo.getSubscriberMethods();</span><br><span class="line">            <span class="keyword">for</span> (SubscriberMethod subscriberMethod : array) &#123;</span><br><span class="line">                <span class="keyword">if</span> (findState.checkAdd(subscriberMethod.method, subscriberMethod.eventType)) &#123;</span><br><span class="line">                    findState.subscriberMethods.add(subscriberMethod);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            findUsingReflectionInSingleClass(findState);</span><br><span class="line">        &#125;</span><br><span class="line">        findState.moveToSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getMethodsAndRelease(findState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>subscriberInfo</code> åœ¨è¿™é‡Œé¢èµ·åˆ°è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œå¦‚æœä¸ºç©ºå°±ä¼šå†æ¬¡ä½¿ç”¨åå°„è·å–è®¢é˜…æ–¹æ³•ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™é€šè¿‡ <code>subscriberInfo.getSubscriberMethods()</code> æ–¹æ³•æ¥è·å–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubscriberInfo.java</span></span><br><span class="line"><span class="comment">/** Base class for generated index classes created by annotation processing. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SubscriberInfo</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; getSubscriberClass();</span><br><span class="line"></span><br><span class="line">    SubscriberMethod[] getSubscriberMethods();</span><br><span class="line"></span><br><span class="line">    <span class="function">SubscriberInfo <span class="title">getSuperSubscriberInfo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">shouldCheckSuperclass</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ³¨é‡Šå°±å¯ä»¥çŸ¥é“ï¼Œè¿™æ˜¯é€šè¿‡æ³¨è§£åœ¨ç¼–è¯‘æ—¶æœŸå°±å·²ç»è·å–äº†ç›¸å…³è®¢é˜…æ–¹æ³•ï¼Œå› æ­¤åœ¨è¿™é‡Œå°±å¯ä»¥å¾ˆå¿«çš„å¾—åˆ°ï¼Œæé«˜äº†æ€§èƒ½ï¼ˆæˆ‘ä»¬å‰é¢ä½¿ç”¨çš„æ—¶å€™å¹¶æ²¡æœ‰å¼•å…¥æ³¨è§£ç›¸å…³çš„ï¼Œå¦‚æœæƒ³äº†è§£ EventBus æ³¨è§£çš„ä½¿ç”¨è¯·æŸ¥çœ‹<a href="http://greenrobot.org/eventbus/documentation/subscriber-index/" target="_blank" rel="noopener">Subscriber Index</a>ï¼‰ã€‚å…³äºæ³¨è§£è¿™é‡Œç®€å•è¯´ä¸€ä¸‹ï¼Œå†…éƒ¨ä¹Ÿæ˜¯ä½¿ç”¨åå°„è·å–ç›¸å…³æ–¹æ³•ï¼Œåªæ˜¯å°†è·å–çš„æ—¶æœºæå‰åˆ°äº†ç¼–è¯‘æ—¶æœŸï¼Œå…·ä½“çš„è¯å°±ä¸å†æ·±å…¥ï¼Œå„ä½å¦‚æœæœ‰å…´è¶£å¯ä»¥å»ç ”ç©¶ä¸€ä¸‹ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œçœ‹ä¸€ä¸‹é‡‡ç”¨åå°„è·å–æ–¹æ³•çš„æ–¹å¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubscriberMethodFinder.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">findUsingReflection</span><span class="params">(Class&lt;?&gt; subscriberClass)</span> </span>&#123;</span><br><span class="line">    FindState findState = prepareFindState();</span><br><span class="line">    findState.initForSubscriber(subscriberClass);</span><br><span class="line">    <span class="keyword">while</span> (findState.clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">        findUsingReflectionInSingleClass(findState);</span><br><span class="line">        findState.moveToSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> getMethodsAndRelease(findState);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">findUsingReflectionInSingleClass</span><span class="params">(FindState findState)</span> </span>&#123;</span><br><span class="line">    Method[] methods;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// This is faster than getMethods, especially when subscribers are fat classes like Activities</span></span><br><span class="line">        methods = findState.clazz.getDeclaredMethods();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">        <span class="comment">// Workaround for java.lang.NoClassDefFoundError, see https://github.com/greenrobot/EventBus/issues/149</span></span><br><span class="line">        methods = findState.clazz.getMethods();</span><br><span class="line">        findState.skipSuperClasses = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">        <span class="keyword">int</span> modifiers = method.getModifiers();</span><br><span class="line">        <span class="keyword">if</span> ((modifiers &amp; Modifier.PUBLIC) != <span class="number">0</span> &amp;&amp; (modifiers &amp; MODIFIERS_IGNORE) == <span class="number">0</span>) &#123;</span><br><span class="line">            Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">            <span class="keyword">if</span> (parameterTypes.length == <span class="number">1</span>) &#123;</span><br><span class="line">                Subscribe subscribeAnnotation = method.getAnnotation(Subscribe<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                <span class="keyword">if</span> (subscribeAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Class&lt;?&gt; eventType = parameterTypes[<span class="number">0</span>];</span><br><span class="line">                    <span class="keyword">if</span> (findState.checkAdd(method, eventType)) &#123;</span><br><span class="line">                        ThreadMode threadMode = subscribeAnnotation.threadMode();</span><br><span class="line">                        findState.subscriberMethods.add(<span class="keyword">new</span> SubscriberMethod(method, eventType, threadMode,</span><br><span class="line">                                subscribeAnnotation.priority(), subscribeAnnotation.sticky()));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºæœ¬éƒ½æ˜¯åå°„çš„åŸºæœ¬ç”¨æ³•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œçˆ¶ç±»çš„ç›¸å…³æ–¹æ³•ä¹Ÿä¼šè¿›è¡ŒæŸ¥æ‰¾ï¼Œä½†ä¼šè¿‡æ»¤æ‰ç³»ç»Ÿæœ¬èº«çš„ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//SubscriberMethodFinder.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> POOL_SIZE = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> FindState[] FIND_STATE_POOL = <span class="keyword">new</span> FindState[POOL_SIZE];</span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;SubscriberMethod&gt; <span class="title">getMethodsAndRelease</span><span class="params">(FindState findState)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">synchronized</span> (FIND_STATE_POOL) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; POOL_SIZE; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (FIND_STATE_POOL[i] == <span class="keyword">null</span>) &#123;</span><br><span class="line">                FIND_STATE_POOL[i] = findState;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> subscriberMethods;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> FindState <span class="title">prepareFindState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (FIND_STATE_POOL) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; POOL_SIZE; i++) &#123;</span><br><span class="line">            FindState state = FIND_STATE_POOL[i];</span><br><span class="line">            <span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                FIND_STATE_POOL[i] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FindState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢å¤–è¯´ä¸€ä¸‹ <code>FIND_STATE_POOL</code> ï¼Œåœ¨é˜…è¯»æºç çš„æ—¶å€™ä¼šå‘ç°å¾ˆå¤šåœ°æ–¹éƒ½ä½¿ç”¨åˆ°äº† Poolï¼Œæ¯”å¦‚ Handler çš„ Message Poolï¼ŒGlide å’Œ Fresco çš„ BitmapPool ç­‰ç­‰ï¼Œä½¿ç”¨ Pool çš„å¥½å¤„æ˜¾è€Œæ˜“è§ï¼Œé¿å…é‡å¤çš„åˆ›å»ºå¯¹è±¡ã€‚</p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨åå°„æˆ–æ³¨è§£çš„æ–¹å¼è·å–åˆ°äº†è®¢é˜…ç±»ä¸­è®¢é˜…æ–¹æ³•çš„é›†åˆï¼Œç„¶åæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹å¦‚ä½•å¤„ç†é›†åˆä¸­çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EventBus.java</span></span><br><span class="line"><span class="comment">// Must be called in synchronized block</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Object subscriber, SubscriberMethod subscriberMethod)</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; eventType = subscriberMethod.eventType;</span><br><span class="line">    Subscription newSubscription = <span class="keyword">new</span> Subscription(subscriber, subscriberMethod);</span><br><span class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span><br><span class="line">    <span class="keyword">if</span> (subscriptions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        subscriptions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">        subscriptionsByEventType.put(eventType, subscriptions);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> size = subscriptions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= size; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == size || subscriberMethod.priority &gt; subscriptions.get(i).subscriberMethod.priority) &#123;</span><br><span class="line">            subscriptions.add(i, newSubscription);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; subscribedEvents = typesBySubscriber.get(subscriber);</span><br><span class="line">    <span class="keyword">if</span> (subscribedEvents == <span class="keyword">null</span>) &#123;</span><br><span class="line">        subscribedEvents = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        typesBySubscriber.put(subscriber, subscribedEvents);</span><br><span class="line">    &#125;</span><br><span class="line">    subscribedEvents.add(eventType);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (subscriberMethod.sticky) &#123;</span><br><span class="line">        <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">            <span class="comment">// Existing sticky events of all subclasses of eventType have to be considered.</span></span><br><span class="line">            <span class="comment">// Note: Iterating over all events may be inefficient with lots of sticky events,</span></span><br><span class="line">            <span class="comment">// thus data structure should be changed to allow a more efficient lookup</span></span><br><span class="line">            <span class="comment">// (e.g. an additional map storing sub classes of super classes: Class -&gt; List&lt;Class&gt;).</span></span><br><span class="line">            Set&lt;Map.Entry&lt;Class&lt;?&gt;, Object&gt;&gt; entries = stickyEvents.entrySet();</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Class&lt;?&gt;, Object&gt; entry : entries) &#123;</span><br><span class="line">                Class&lt;?&gt; candidateEventType = entry.getKey();</span><br><span class="line">                <span class="keyword">if</span> (eventType.isAssignableFrom(candidateEventType)) &#123;</span><br><span class="line">                    Object stickyEvent = entry.getValue();</span><br><span class="line">                    checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Object stickyEvent = stickyEvents.get(eventType);</span><br><span class="line">            checkPostStickyEventToSubscription(newSubscription, stickyEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Subscription.java</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Subscription</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Object subscriber;</span><br><span class="line">    <span class="keyword">final</span> SubscriberMethod subscriberMethod;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Becomes false as soon as &#123;<span class="doctag">@link</span> EventBus#unregister(Object)&#125; is called, which is checked by queued event delivery</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@link</span> EventBus#invokeSubscriber(PendingPost)&#125; to prevent race conditions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> active;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨é‡Šä¸Šè¦æ±‚ <code>subscribe</code> æ–¹æ³•å¿…é¡»è¿è¡Œåœ¨åŒæ­¥ä»£ç å—ä¸­ï¼ŒEventBus å¾ˆå¤šåœ°æ–¹ä½¿ç”¨äº† <code>synchronized</code> æ¥ä½¿å¾—åœ¨å¤šçº¿ç¨‹ä¸­å¯ä»¥æ­£å¸¸çš„ä½¿ç”¨ã€‚</p><p>é€šè¿‡ä»£ç å¯ä»¥å‘ç°è¿™é‡Œä¸»è¦å¤„ç†äº†ä¸‰ä»¶äº‹æƒ…ï¼š</p><ol><li>å°†äº‹ä»¶ç±»å‹ï¼ˆå¦‚ MessageEventï¼‰ä½œä¸º Keyï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§ï¼ˆpriorityï¼‰æ’åºçš„è®¢é˜…è€…å«è®¢é˜…æ–¹æ³•åˆ—è¡¨ä½œä¸º value è®°å½•åœ¨ map <code>subscriptionsByEventType</code> ä¸­ã€‚</li><li>è®°å½•è®¢é˜…è€…æ‰€æ‹¥æœ‰çš„æ‰€æœ‰äº‹ä»¶ç±»å‹ã€‚</li><li>å¦‚æœå½“å‰çš„è®¢é˜…æ–¹æ³•æ˜¯ <code>sticky</code> ç²˜æ€§äº‹ä»¶å°±ç›´æ¥å‘é€è¯¥äº‹ä»¶ï¼ˆå‘é€çš„æ–¹æ³•åç»­ä¼šåˆ†æåˆ°ï¼‰ã€‚</li></ol><p>åˆ°è¿™é‡Œæˆ‘ä»¬åˆ†æå®Œäº† <code>EventBus.getDefault().register(subscribe)</code> é‡Œé¢åšäº†ä»€ä¹ˆå¤„ç†ï¼Œç„¶åæˆ‘ä»¬å…ˆåšä¸ªå°ç»“ã€‚</p><p><strong>å°ç»“ï¼šEventBus æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œé€šè¿‡ <code>getDefault()</code> æ–¹æ³•è·å–å®ä¾‹ï¼Œåœ¨ <code>register(Object subscriber)</code> æ–¹æ³•ä¸­ï¼Œå…ˆé€šè¿‡åå°„æˆ–è€…æ³¨è§£çš„æ–¹å¼è·å–åˆ° <code>subscriber</code> ç±»ä¸­æ‰€æœ‰çš„è®¢é˜…æ–¹æ³•ï¼ˆè¢«<code>@Subscribe</code> æ ‡è¯†çš„æ–¹æ³•ï¼‰çš„åˆ—è¡¨ï¼Œç„¶åéå†è¯¥åˆ—è¡¨å¹¶è®°å½•äº‹ä»¶å’Œæ–¹æ³•ï¼ˆæ–¹æ³•æŒ‰ç…§ <code>priority</code> å¤§å°æ’åˆ—ï¼‰ï¼Œå¦‚æœå½“å‰éå†çš„æ–¹æ³•æ˜¯ä¸€ä¸ª <code>sticky</code> å°±ä¼šå…ˆå‘é€è¯¥äº‹ä»¶ã€‚</strong></p><h3 id="3-2-å‘é€äº‹ä»¶-post-å’Œ-postSticky-å’Œå“åº”äº‹ä»¶"><a href="#3-2-å‘é€äº‹ä»¶-post-å’Œ-postSticky-å’Œå“åº”äº‹ä»¶" class="headerlink" title="3.2 å‘é€äº‹ä»¶ post å’Œ postSticky å’Œå“åº”äº‹ä»¶"></a>3.2 å‘é€äº‹ä»¶ post å’Œ postSticky å’Œå“åº”äº‹ä»¶</h3><p>è¿™é‡Œå…ˆç®€å•çœ‹ä¸€ä¸‹å½“æˆ‘ä»¬è°ƒç”¨ post ä¹‹åå†…éƒ¨è°ƒç”¨äº†å“ªäº›æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EventBus.post(Object event)</span><br><span class="line"> -&gt;EventBus.postSingleEvent(Object event, PostingThreadState postingState)</span><br><span class="line">   -&gt;EventBus.postSingleEventForEventType(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass)</span><br><span class="line">    -&gt;EventBus.postToSubscription(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span><br></pre></td></tr></table></figure><p>å‘ç°æœ€ç»ˆéƒ½åˆ° <code>postToSubscription</code> æ–¹æ³•ä¸­ï¼Œè™½ç„¶ <code>postSticky</code> æ²¡åœ¨è¿™é‡Œåˆ—å‡ºæ¥ä½†æ˜¯ä¸€æ ·çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€ä¸ªä¸ªæ–¹æ³•è·Ÿè¿‡å»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EventBus.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">post</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">    PostingThreadState postingState = currentPostingThreadState.get();</span><br><span class="line">    List&lt;Object&gt; eventQueue = postingState.eventQueue;</span><br><span class="line">    eventQueue.add(event);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!postingState.isPosting) &#123;</span><br><span class="line">        postingState.isMainThread = isMainThread();</span><br><span class="line">        postingState.isPosting = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (postingState.canceled) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Internal error. Abort state was not reset"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (!eventQueue.isEmpty()) &#123;</span><br><span class="line">                postSingleEvent(eventQueue.remove(<span class="number">0</span>), postingState);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            postingState.isPosting = <span class="keyword">false</span>;</span><br><span class="line">            postingState.isMainThread = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postSingleEvent</span><span class="params">(Object event, PostingThreadState postingState)</span> <span class="keyword">throws</span> Error </span>&#123;</span><br><span class="line">    Class&lt;?&gt; eventClass = event.getClass();</span><br><span class="line">    <span class="keyword">boolean</span> subscriptionFound = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (eventInheritance) &#123;</span><br><span class="line">        List&lt;Class&lt;?&gt;&gt; eventTypes = lookupAllEventTypes(eventClass);</span><br><span class="line">        <span class="keyword">int</span> countTypes = eventTypes.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> h = <span class="number">0</span>; h &lt; countTypes; h++) &#123;</span><br><span class="line">            Class&lt;?&gt; clazz = eventTypes.get(h);</span><br><span class="line">            subscriptionFound |= postSingleEventForEventType(event, postingState, clazz);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        subscriptionFound = postSingleEventForEventType(event, postingState, eventClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œä»å½“å‰çº¿ç¨‹ä¸­è·å–åˆ° <code>postingState</code> ï¼Œè¿™é‡Œ <code>PostingThreadState</code> æ˜¯ä»  <code>ThreadLocal</code> ï¼ˆçº¿ç¨‹æœ¬åœ°å­˜å‚¨åŒºï¼‰åˆå§‹åŒ–è·å–ï¼Œä¿è¯æ¯ä¸ªçº¿ç¨‹çš„ <code>postingState</code> éƒ½æ˜¯ç‹¬ç«‹ã€‚ç„¶åå°†äº‹ä»¶æ”¾å…¥é˜Ÿåˆ—ï¼ŒæŒ‰å…ˆè¿›å…ˆå‡ºé¡ºåºå‘é€ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„ <strong><code>eventInheritance</code> è¿™ä¸ªå‚æ•°ï¼Œå®ƒä¸»è¦ç”¨æ¥æ§åˆ¶æ˜¯å¦è§¦å‘å½“å‰äº‹ä»¶çš„çˆ¶ç±»äº‹ä»¶çš„æ–¹æ³•</strong>ï¼Œä»€ä¹ˆæ„æ€å‘¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">open inner <span class="class"><span class="keyword">class</span> <span class="title">MessageEvent</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">inner class <span class="title">SubMessageEvent</span><span class="params">()</span> : <span class="title">MessageEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Subscribe</span></span><br><span class="line"><span class="function">fun <span class="title">onMessageEvent</span><span class="params">(messageEvent: MessageEvent)</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Subscribe</span></span><br><span class="line"><span class="function">fun <span class="title">onSubMessageEvent</span><span class="params">(subMessageEvent: SubMessageEvent)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ª <code>MessageEvent</code> äº‹ä»¶ï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªç»§æ‰¿äº <code>MessageEvent</code> çš„ <code>SubMessageEvent</code> çš„äº‹ä»¶ï¼ŒåŒæ—¶è®¢é˜…è¿™ä¸¤ä¸ªäº‹ä»¶ã€‚</p><p>è¿™æ—¶å¦‚æœå‘é€ä¸€ä¸ª <code>SubMessageEvent</code> äº‹ä»¶ <code>EventBus.getDefault().post(SubMessageEvent())</code> ï¼Œ<code>onMessageEvent()</code> å’Œ <code>onSubMessageEvent()</code> è¿™ä¸¤ä¸ªæ–¹æ³•ä¼šè¢«åŒæ—¶è§¦å‘ï¼Œå³éƒ½ä¼šæ¥æ”¶åˆ°äº‹ä»¶ã€‚å¦‚æœä¸æƒ³çˆ¶ç±»äº‹ä»¶çš„è®¢é˜…æ–¹æ³•è¢«è§¦å‘çš„è¯ï¼Œéœ€è¦å°† <code>eventInheritance</code> è®¾ä¸º <code>false</code> ï¼Œé»˜è®¤ä¸º <code>true</code>ã€‚</p><p><code>eventInheritance</code> è¿™ä¸ªå‚æ•°åœ¨ä¸Šä¸€èŠ‚ <code>register</code> ä¸­ä¹Ÿæœ‰ä½¿ç”¨åˆ°ï¼Œéœ€è¦æ³¨æ„ä¸‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EventBus.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">postSingleEventForEventType</span><span class="params">(Object event, PostingThreadState postingState, Class&lt;?&gt; eventClass)</span> </span>&#123;</span><br><span class="line">    CopyOnWriteArrayList&lt;Subscription&gt; subscriptions;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        subscriptions = subscriptionsByEventType.get(eventClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span> &amp;&amp; !subscriptions.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Subscription subscription : subscriptions) &#123;</span><br><span class="line">            postingState.event = event;</span><br><span class="line">            postingState.subscription = subscription;</span><br><span class="line">            <span class="keyword">boolean</span> aborted = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                postToSubscription(subscription, event, postingState.isMainThread);</span><br><span class="line">                aborted = postingState.canceled;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                postingState.event = <span class="keyword">null</span>;</span><br><span class="line">                postingState.subscription = <span class="keyword">null</span>;</span><br><span class="line">                postingState.canceled = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (aborted) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦æ˜¯æ‰¾åˆ°å¯¹åº”äº‹ä»¶çš„è®¢é˜…ç±»ï¼Œç„¶åå¾ªç¯å‘é€ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EventBus.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">postToSubscription</span><span class="params">(Subscription subscription, Object event, <span class="keyword">boolean</span> isMainThread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (subscription.subscriberMethod.threadMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> POSTING:</span><br><span class="line">            invokeSubscriber(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAIN:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> MAIN_ORDERED:</span><br><span class="line">            <span class="keyword">if</span> (mainThreadPoster != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mainThreadPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// temporary: technically not correct as poster not decoupled from subscriber</span></span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> BACKGROUND:</span><br><span class="line">            <span class="keyword">if</span> (isMainThread) &#123;</span><br><span class="line">                backgroundPoster.enqueue(subscription, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                invokeSubscriber(subscription, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ASYNC:</span><br><span class="line">            asyncPoster.enqueue(subscription, event);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unknown thread mode: "</span> + subscription.subscriberMethod.threadMode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subscription.subscriberMethod.method.invoke(subscription.subscriber, event);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç° <code>postToSubscription</code> æ–¹æ³•ä¸»è¦å¤„ç†æ ¹æ®è®¢é˜…æ–¹æ³•æŒ‡å®šçš„ <code>threadMode</code> åˆ‡æ¢åˆ°å¯¹åº”çš„çº¿ç¨‹ï¼Œæœ€ååœ¨è¯¥çº¿ç¨‹é€šè¿‡ <code>invoke</code> æ–¹å¼è°ƒåˆ°è®¢é˜…æ–¹æ³•ã€‚</p><p><code>ThreadMode</code> çº¿ç¨‹æ¨¡å¼ï¼Œç›®å‰æœ‰ 5 ç§ï¼š</p><ol><li>POSTINGï¼šè®¢é˜…æ–¹æ³•è¢«è°ƒç”¨çš„çº¿ç¨‹è·Ÿå‘é€äº‹ä»¶æ‰€åœ¨çš„çº¿ç¨‹æ˜¯åŒä¸€ä¸ªã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šçš„è¯ï¼Œè¿™ä¸ªæ˜¯é»˜è®¤çš„çº¿ç¨‹æ¨¡å¼ã€‚éœ€è¦æ³¨æ„ç”±äºå¯èƒ½è¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸èƒ½è¿›è¡Œè€—æ—¶æ“ä½œï¼Œå¦åˆ™ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚</li><li>MAINï¼šè®¢é˜…æ–¹æ³•å°†åœ¨ä¸»çº¿ç¨‹ï¼ˆUI çº¿ç¨‹ï¼‰è¢«è°ƒç”¨ï¼Œä¸ç®¡å‘é€äº‹ä»¶åœ¨å“ªä¸ªçº¿ç¨‹ã€‚å¦‚æœå‘é€äº‹ä»¶æ°å¥½åœ¨ä¸»çº¿ç¨‹åˆ™ç›´æ¥è°ƒç”¨ï¼Œå¦‚æœä¸åœ¨ä¸»çº¿ç¨‹åˆ™é€šè¿‡ <code>mainThreadPoster</code> æ¥åˆ‡æ¢çº¿ç¨‹è°ƒç”¨ã€‚</li><li>MAIN_ORDEREDï¼šè·Ÿ MAIN æ–¹æ³•å·®ä¸å¤šéƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹è°ƒç”¨ï¼Œä¸åŒçš„æ˜¯ï¼Œäº‹ä»¶æ˜¯åœ¨é˜Ÿåˆ—ä¸­æ’é˜Ÿç­‰å¾…è°ƒç”¨ã€‚æ­¤æ—¶å‘é€äº‹ä»¶çš„æ–¹æ³•ä¸ä¼šè¢«é˜»å¡ã€‚</li><li>BACKGROUNDï¼šè®¢é˜…æ–¹æ³•å°†åœ¨åå°çº¿ç¨‹è¢«è°ƒç”¨ã€‚å¦‚æœå‘é€äº‹ä»¶çš„æ–¹æ³•ä¸åœ¨ä¸»çº¿ç¨‹ï¼Œå°±ç›´æ¥è°ƒç”¨è®¢é˜…æ–¹æ³•ï¼›å¦‚æœåœ¨ä¸»çº¿ç¨‹ï¼Œåˆ™ç”¨ä¸€ä¸ªå•ä¸€çš„å­çº¿ç¨‹æŒ‰é¡ºåºè°ƒç”¨è®¢é˜…æ–¹æ³•ï¼Œæ‰€ä»¥ä¸ºäº†é¿å…å½±å“åˆ°å…¶ä»–æ¥æ”¶äº‹ä»¶æ–¹æ³•çš„æ‰§è¡Œï¼Œä¸èƒ½åœ¨è®¢é˜…æ–¹æ³•ä¸­å¤„ç†è€—æ—¶æ“ä½œï¼Œå¦‚æœè¦å¤„ç†è€—æ—¶æ“ä½œåˆ™ä½¿ç”¨ <code>ASYNC</code>ã€‚</li><li>ASYNCï¼šè®¢é˜…æ–¹æ³•ä¼šåœ¨å¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹ä¸­è¢«è°ƒç”¨ã€‚ä¸ç®¡å‘é€äº‹ä»¶æ‰€å¤„çš„çº¿ç¨‹åœ¨åå°è¿˜æ˜¯ä¸»çº¿ç¨‹ï¼Œéƒ½æ˜¯é‡æ–°å¯ç”¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹æ¥è°ƒç”¨è®¢é˜…æ–¹æ³•ã€‚æ­¤æ¨¡å¼å¯ä»¥ç”¨æ¥å¤„ç†è€—æ—¶æ“ä½œã€‚</li></ol><p>ä¸Šé¢æˆ‘ä»¬å¤§æ¦‚äº†è§£ä¸€ä¸‹å„ç§çº¿ç¨‹æ¨¡å¼ä¸‹è°ƒç”¨è®¢é˜…æ–¹æ³•çš„æ˜¯æ–¹å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ·±å…¥äº†çœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•è¿›è¡Œçº¿ç¨‹é—´åˆ‡æ¢çš„å‘¢ã€‚</p><p>é¦–å…ˆï¼Œ<strong>POSTING</strong> ç›´æ¥è°ƒç”¨ï¼Œæ²¡å•¥å¥½è¯´çš„ã€‚</p><p>æ¥ä¸‹æ¥ <strong>MAIN</strong>ï¼Œåˆ†ä¸ºä¸¤ä¸ªæ¡ä»¶ï¼Œå¦‚æœå½“å‰å°±åœ¨ä¸»çº¿ç¨‹ï¼Œç›´æ¥è°ƒç”¨ï¼›å¦åˆ™è¿›å…¥ <code>mainThreadPoster.enqueue(subscription, event)</code> æ–¹æ³•ã€‚ä¸»çº¿ç¨‹çš„åˆ¤æ–­ä¹‹å‰æ²¡æåˆ°ï¼Œè¿™é‡Œç®€å•è¯´ä¸€ä¸‹ï¼Œä¸»è¦æ˜¯é€šè¿‡ Looper çš„æ–¹å¼ <code>Looper.myLooper() == Looper.getMainLooper()</code>ã€‚</p><p>å…ˆæ¥çœ‹çœ‹ <code>mainThreadPoster</code> å®ä¾‹æ—¶å¦‚ä½•ç”Ÿæˆçš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EventBus.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MainThreadSupport mainThreadSupport;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Poster mainThreadPoster;</span><br><span class="line"></span><br><span class="line">mainThreadSupport = builder.getMainThreadSupport();</span><br><span class="line">mainThreadPoster = mainThreadSupport != <span class="keyword">null</span> ? mainThreadSupport.createPoster(<span class="keyword">this</span>) : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//MainThreadSupport.AndroidHandlerMainThreadSupport.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Poster <span class="title">createPoster</span><span class="params">(EventBus eventBus)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HandlerPoster(eventBus, looper, <span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//EventBusBuilder.java</span></span><br><span class="line"><span class="function">MainThreadSupport <span class="title">getMainThreadSupport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    Object looperOrNull = getAndroidMainLooperOrNull();</span><br><span class="line">    <span class="keyword">return</span> looperOrNull == <span class="keyword">null</span> ? <span class="keyword">null</span> :</span><br><span class="line">                <span class="keyword">new</span> MainThreadSupport.AndroidHandlerMainThreadSupport((Looper) looperOrNull);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Object <span class="title">getAndroidMainLooperOrNull</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> Looper.getMainLooper();</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç° <code>mainThreadPoster</code> æ˜¯ HandlerPoster çš„å®ä¾‹ï¼Œéœ€è¦æ³¨æ„è¿™é‡Œä¼ å…¥äº†ä¸€ä¸ªå‚æ•° <code>MainLooper</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerPoster</span> <span class="keyword">extends</span> <span class="title">Handler</span> <span class="keyword">implements</span> <span class="title">Poster</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxMillisInsideHandleMessage;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> handlerActive;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</span><br><span class="line">        PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            queue.enqueue(pendingPost);</span><br><span class="line">            <span class="keyword">if</span> (!handlerActive) &#123;</span><br><span class="line">                handlerActive = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Could not send handler message"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> rescheduled = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> started = SystemClock.uptimeMillis();</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                PendingPost pendingPost = queue.poll();</span><br><span class="line">                <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                        <span class="comment">// Check again, this time in synchronized</span></span><br><span class="line">                        pendingPost = queue.poll();</span><br><span class="line">                        <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            handlerActive = <span class="keyword">false</span>;</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                eventBus.invokeSubscriber(pendingPost);</span><br><span class="line">                <span class="keyword">long</span> timeInMethod = SystemClock.uptimeMillis() - started;</span><br><span class="line">                <span class="keyword">if</span> (timeInMethod &gt;= maxMillisInsideHandleMessage) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!sendMessage(obtainMessage())) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> EventBusException(<span class="string">"Could not send handler message"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    rescheduled = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            handlerActive = rescheduled;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//EventBus.java</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">invokeSubscriber</span><span class="params">(PendingPost pendingPost)</span> </span>&#123;</span><br><span class="line">    Object event = pendingPost.event;</span><br><span class="line">    Subscription subscription = pendingPost.subscription;</span><br><span class="line">    PendingPost.releasePendingPost(pendingPost);</span><br><span class="line">    <span class="keyword">if</span> (subscription.active) &#123;</span><br><span class="line">        invokeSubscriber(subscription, event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç° HandlerPoster å°±æ˜¯ä¸€ä¸ª Handler ï¼Œåœ¨åŠ ä¸Šå‰é¢å®ä¾‹åŒ– HandlerPoster çš„æ—¶å€™æŒ‡å®šçš„ Looper æ˜¯ä¸€ä¸ª MainLooperï¼Œé‚£å°±å¯ä»¥ç¡®ä¿ <code>HandlerPoster.handleMessage()</code> è¿è¡Œåœ¨ä¸»çº¿ç¨‹äº†ã€‚å…·ä½“æºç æ¯”è¾ƒç®€å•å°±ä¸ä¸€ä¸€è§£æã€‚</p><p>æ¥ä¸‹æ¥æ˜¯ <strong>MAIN_ORDERED</strong>ï¼Œè·Ÿ MAIN æ‰€è°ƒç”¨æ–¹æ³•ä¸€è‡´ã€‚</p><p>å†ç„¶åæ˜¯ <strong>BACKGROUND</strong>ï¼Œå¦‚æœå½“å‰åœ¨ä¸»çº¿ç¨‹å°±è¿›å…¥ <code>backgroundPoster.enqueue(subscription, event)</code> ï¼Œå¦åˆ™ç›´æ¥è°ƒç”¨ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BackgroundPoster</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">Poster</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> executorRunning;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</span><br><span class="line">        PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            queue.enqueue(pendingPost);</span><br><span class="line">            <span class="keyword">if</span> (!executorRunning) &#123;</span><br><span class="line">                executorRunning = <span class="keyword">true</span>;</span><br><span class="line">                eventBus.getExecutorService().execute(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    PendingPost pendingPost = queue.poll(<span class="number">1000</span>);</span><br><span class="line">                    <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                            <span class="comment">// Check again, this time in synchronized</span></span><br><span class="line">                            pendingPost = queue.poll();</span><br><span class="line">                            <span class="keyword">if</span> (pendingPost == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                executorRunning = <span class="keyword">false</span>;</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    eventBus.invokeSubscriber(pendingPost);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                eventBus.getLogger().log(Level.WARNING, Thread.currentThread().getName() + <span class="string">" was interruppted"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            executorRunning = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BackgroundPoster æ˜¯ä¸€ä¸ª Runnableï¼Œé€šè¿‡çº¿ç¨‹æ± çš„æ–¹å¼è¿è¡Œåœ¨åå°ã€‚è¿™é‡Œé¢éœ€è¦æ³¨æ„çš„æ˜¯ç”¨äº†å¤šçº¿ç¨‹çš„ä¸œè¥¿ï¼Œå¦‚ <code>wait</code> ï¼Œ <code>notifyAll</code> ï¼Œ<code>synchronized</code> å…³é”®å­—ã€‚</p><p>æœ€åçœ‹ä¸€ä¸‹ <strong>ASYNC</strong>ï¼Œç›´æ¥è°ƒç”¨äº† <code>asyncPoster.enqueue(subscription, event)</code> æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AsyncPoster</span> <span class="keyword">implements</span> <span class="title">Runnable</span>, <span class="title">Poster</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PendingPostQueue queue;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventBus eventBus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueue</span><span class="params">(Subscription subscription, Object event)</span> </span>&#123;</span><br><span class="line">        PendingPost pendingPost = PendingPost.obtainPendingPost(subscription, event);</span><br><span class="line">        queue.enqueue(pendingPost);</span><br><span class="line">        eventBus.getExecutorService().execute(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PendingPost pendingPost = queue.poll();</span><br><span class="line">        <span class="keyword">if</span>(pendingPost == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No pending post available"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        eventBus.invokeSubscriber(pendingPost);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€çœ‹è·Ÿ  BackgroundPoster å·®ä¸å¤šï¼Œä»…ä»…æ˜¯å°‘äº†ä¸€äº›åŒæ­¥é”ç­‰ç›¸å…³çš„å…³é”®å­—ã€‚é‚£ä¹ˆåŒºåˆ«ä»…ä»…æ˜¯è¿™æ ·å—ï¼Œæœ‰ç‚¹æ‡µï¼Ÿ</p><p>ä¹‹å‰è¯´è¿‡ BACKGROUND æ˜¯è¿è¡Œåœ¨å•ä¸€çš„å­çº¿ç¨‹ä¸­ï¼Œä¿è¯äº‹ä»¶æŒ‰é¡ºåºäº¤ä»˜ã€‚è¿™é‡Œä¸€çœ‹éƒ½æ˜¯ä½¿ç”¨ <code>Executors.newCachedThreadPool()</code> çº¿ç¨‹æ± ï¼ˆæœ‰åˆ™ç”¨ï¼Œæ— åˆ™åˆ›å»ºï¼Œæ— æ•°é‡ä¸Šé™ï¼‰ï¼Œé‚£ä¹ˆæ€ä¹ˆä¿è¯â€œå•ä¸€â€å‘¢ï¼Ÿå¯ä»¥å‘ç° <code>ExecutorService().execute(this)</code> ä¹‹å‰ä½¿ç”¨äº† <code>synchronized (this)</code> åŒæ­¥é”å…³é”®å­—ï¼Œä¿è¯äº†ä»»ä¸€æ—¶é—´å†…æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªä»»åŠ¡ä¼šè¢«çº¿ç¨‹æ± æ‰§è¡Œã€‚</p><p>å‰é¢è§£æçš„æ˜¯ <code>post()</code> æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ <code>postSticky()</code> æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EventBus.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postSticky</span><span class="params">(Object event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (stickyEvents) &#123;</span><br><span class="line">        stickyEvents.put(event.getClass(), event);</span><br><span class="line">    &#125;</span><br><span class="line">    post(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»…ä»…å¤šäº†å°† <code>stickyEvents</code> äº‹ä»¶ä¿å­˜ Map ä¸­ã€‚</p><p>å¥½äº†ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬å¤§è‡´åˆ†æå®Œäº†å‘é€äº‹ä»¶ post å’Œ postSticky å’Œå“åº”äº‹ä»¶ï¼Œç®€å•åšä¸ªæ€»ç»“ï¼š</p><p><strong>æ ¹æ® <code>event</code> çš„ç±»å‹ï¼Œåœ¨ç¬¬ä¸€æ­¥ <code>register</code> ä¸­ä¿å­˜çš„ <code>subscriptionsByEventType</code> Map ä¸­è·å–åˆ°å¯¹åº”çš„è®¢é˜…ç±»å’Œæ–¹æ³• <code>Subscription</code>ï¼Œå°†å…¶åŠ å…¥åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œå¾ªç¯é˜Ÿåˆ—æŒ‰åºå–å‡ºäº‹ä»¶ï¼Œæ ¹æ®è®¢é˜…æ–¹æ³•æŒ‡å®šçš„ <code>threadMode</code> çº¿ç¨‹æ¨¡å¼åˆ‡æ¢åˆ°å¯¹åº”çš„çº¿ç¨‹è°ƒç”¨è®¢é˜…æ–¹æ³•ã€‚</strong></p><h3 id="3-3-å–æ¶ˆè®¢é˜…-unregister"><a href="#3-3-å–æ¶ˆè®¢é˜…-unregister" class="headerlink" title="3.3 å–æ¶ˆè®¢é˜… unregister"></a>3.3 å–æ¶ˆè®¢é˜… unregister</h3><p>æœ€åï¼Œå¦‚æœè¦é€€å‡ºçš„è¯ï¼Œä¸€èˆ¬éƒ½éœ€è¦å–æ¶ˆè®¢é˜…ï¼Œé˜²æ­¢æ³„éœ²ã€‚å¤„ç†çš„è¯ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯ç§»é™¤åœ¨è®¢é˜…æ˜¯æ‰€è®°å½•çš„é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//EventBus.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">unregister</span><span class="params">(Object subscriber)</span> </span>&#123;</span><br><span class="line">    List&lt;Class&lt;?&gt;&gt; subscribedTypes = typesBySubscriber.get(subscriber);</span><br><span class="line">    <span class="keyword">if</span> (subscribedTypes != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; eventType : subscribedTypes) &#123;</span><br><span class="line">            unsubscribeByEventType(subscriber, eventType);</span><br><span class="line">        &#125;</span><br><span class="line">        typesBySubscriber.remove(subscriber);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.log(Level.WARNING, <span class="string">"Subscriber to unregister was not registered before: "</span> + subscriber.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unsubscribeByEventType</span><span class="params">(Object subscriber, Class&lt;?&gt; eventType)</span> </span>&#123;</span><br><span class="line">    List&lt;Subscription&gt; subscriptions = subscriptionsByEventType.get(eventType);</span><br><span class="line">    <span class="keyword">if</span> (subscriptions != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> size = subscriptions.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            Subscription subscription = subscriptions.get(i);</span><br><span class="line">            <span class="keyword">if</span> (subscription.subscriber == subscriber) &#123;</span><br><span class="line">                subscription.active = <span class="keyword">false</span>;</span><br><span class="line">                subscriptions.remove(i);</span><br><span class="line">                i--;</span><br><span class="line">                size--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h2><p>é€šè¿‡ä»¥ä¸Šçš„åˆ†æï¼Œç›¸ä¿¡å¤§å®¶å¯¹ EventBus çš„åŸç†æœ‰äº†è¿›ä¸€æ­¥çš„ç†è§£ã€‚EventBus å½“ä¸­è¿ç”¨äº†å¾ˆå¤š <code>synchronized</code> åœ¨é˜…è¯»æºç çš„æ—¶å€™å¯ä»¥ä»”ç»†ä½“ä¼šä¸€ä¸‹ EventBus æ˜¯å¦‚ä½•ä¿è¯å¤šçº¿ç¨‹ä¸‹è¿è¡Œçš„æ­£å¸¸ï¼Œè¿˜æœ‰é‡Œé¢æ‰€ç”¨åˆ°çš„å¦‚ Pool çš„è¿ç”¨ä»¥åŠåå°„ç­‰ç­‰ã€‚</p><h2 id="äº”ã€èµ„æºä¸æ¨è"><a href="#äº”ã€èµ„æºä¸æ¨è" class="headerlink" title="äº”ã€èµ„æºä¸æ¨è"></a>äº”ã€èµ„æºä¸æ¨è</h2><ol><li><a href="https://github.com/greenrobot/EventBus" target="_blank" rel="noopener">EventBus</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ä¸€ã€å‰è¨€&quot;&gt;&lt;a href=&quot;#ä¸€ã€å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€å‰è¨€&quot;&gt;&lt;/a&gt;ä¸€ã€å‰è¨€&lt;/h2&gt;&lt;p&gt;EventBus ç›¸ä¿¡å¤§å®¶å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œä¸€ä¸ªå‘å¸ƒ/è®¢é˜…äº‹ä»¶çš„å¤„ç†åº“ã€‚&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬è¿™é‡Œå°†ä¼šä»ä½¿ç”¨åˆ°åŸç†æ¥è¿›ä¸€æ­¥ç†è§£ EventBus ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://wangpeiyuan.cn/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>Android Handler æºç æµ…æ</title>
    <link href="http://wangpeiyuan.cn/2019/11/26/Android-handler-source-code-analysis/"/>
    <id>http://wangpeiyuan.cn/2019/11/26/Android-handler-source-code-analysis/</id>
    <published>2019-11-26T14:22:32.000Z</published>
    <updated>2019-12-21T14:37:13.131Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€å‰è¨€"><a href="#ä¸€ã€å‰è¨€" class="headerlink" title="ä¸€ã€å‰è¨€"></a>ä¸€ã€å‰è¨€</h2><p>Handler åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­éšå¤„å¯è§ï¼Œä¸€èˆ¬ç”¨æ¥è§£å†³å­çº¿ç¨‹æ— æ³•è®¿é—®ä¸»çº¿ç¨‹ï¼ˆUI çº¿ç¨‹ï¼‰ä¸­çš„ UI é—®é¢˜çš„ã€‚</p><p>ä¸‹æ–‡ä¼šé€šè¿‡ Handler çš„åŸºæœ¬ç”¨æ³•ï¼Œå¹¶æ·±å…¥æºç æµ…æ Handler çš„è¿è¡Œæœºåˆ¶ã€‚</p><a id="more"></a><h2 id="äºŒã€Handler-åŸºæœ¬ç”¨æ³•"><a href="#äºŒã€Handler-åŸºæœ¬ç”¨æ³•" class="headerlink" title="äºŒã€Handler åŸºæœ¬ç”¨æ³•"></a>äºŒã€Handler åŸºæœ¬ç”¨æ³•</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•è¿‡ä¸€ä¸‹ Handler çš„å‡ ç§ç”¨æ³•ã€‚</p><p>ç¬¬ä¸€ç§ï¼šä¸»çº¿ç¨‹å®ä¾‹åŒ–ä¸€ä¸ª Handler å¹¶é‡å†™ <code>handleMessage</code> æ–¹æ³•ï¼Œç„¶ååœ¨éœ€è¦çš„æ—¶å€™è°ƒç”¨ <code>send</code> æˆ– <code>post</code> ç­‰ç³»åˆ—æ–¹æ³•å°±è¡Œã€‚æ­¤æ—¶ <code>handleMessage</code> å’Œ  <code>Runnable</code>  è¿è¡Œåœ¨ä¸»çº¿ç¨‹ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸»çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">val</span> handler: Handler = <span class="keyword">object</span> : Handler() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleMessage</span><span class="params">(msg: <span class="type">Message</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.handleMessage(msg)</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//å­çº¿ç¨‹å‘é€æ¶ˆæ¯</span></span><br><span class="line">Thread &#123;</span><br><span class="line">    <span class="comment">//ç¬¬ä¸€ç§ç”¨æ³•ï¼šå­çº¿ç¨‹å‘é€ msg</span></span><br><span class="line">    <span class="keyword">val</span> msg: Message = handler.obtainMessage()</span><br><span class="line">    handler.sendMessage(msg)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ç¬¬äºŒç§ç”¨æ³•ï¼špost</span></span><br><span class="line">    handler.post &#123;</span><br><span class="line">        <span class="comment">//ä¸»çº¿ç¨‹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;.start()</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç§ï¼šåœ¨å­çº¿ç¨‹å®ä¾‹åŒ– Handlerï¼Œéœ€è¦æ³¨æ„æ˜¯åœ¨å®ä¾‹åŒ–ä¹‹å‰è¦å…ˆåˆ›å»º Looperï¼Œå¦åˆ™ä¼šæŠ›å‡º <code>Can&#39;t create handler inside thread...</code> å¼‚å¸¸ã€‚åˆ›å»º Looper æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€æ˜¯è°ƒç”¨ <code>Looper.prepare()</code> ï¼Œæ­¤æ—¶ Handler è¿è¡Œåœ¨å­çº¿ç¨‹ä¸­ï¼›äºŒæ˜¯è°ƒç”¨ <code>Looper.getMainLooper()</code> å¾—åˆ° Looper å¹¶ä½œä¸ºå®ä¾‹åŒ– Handler æ—¶æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œæ­¤æ—¶ Handler è¿è¡Œåœ¨ä¸»çº¿ç¨‹ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//handler è¿è¡Œåœ¨å­çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">var</span> handler: Handler</span><br><span class="line">Thread &#123;</span><br><span class="line">    Looper.prepare()</span><br><span class="line">    handler = <span class="keyword">object</span> : Handler() &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleMessage</span><span class="params">(msg: <span class="type">Message</span>?)</span></span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.handleMessage(msg)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Looper.loop()</span><br><span class="line">&#125;.start()</span><br><span class="line"></span><br><span class="line"><span class="comment">//handler è¿è¡Œåœ¨ä¸»çº¿ç¨‹</span></span><br><span class="line">Thread &#123;</span><br><span class="line">    <span class="keyword">val</span> looper = Looper.getMainLooper()</span><br><span class="line">    handler = <span class="keyword">object</span> : Handler(looper) &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleMessage</span><span class="params">(msg: <span class="type">Message</span>?)</span></span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.handleMessage(msg)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.start()</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ä¸¤ç§ç®€å•çš„ä½¿ç”¨ï¼Œå¦‚æœæˆ‘ä»¬è¿›ä¸€æ­¥æƒ³çš„è¯ï¼Œä¼šäº§ç”Ÿå‡ ä¸ªç–‘é—®ï¼Œæ¯”å¦‚ï¼š</p><ol><li><strong>ä¸ºå•¥åœ¨å­çº¿ç¨‹éœ€è¦è°ƒç”¨ <code>Looper.prepare()</code> ç­‰æ–¹å¼è€Œä¸»çº¿ç¨‹å´ä¸éœ€è¦ï¼Ÿ</strong></li><li><strong><code>send</code> å’Œ <code>post</code> ä¹‹ååšäº†ä»€ä¹ˆå¤„ç†ï¼Œ<code>handleMessage</code> ä»€ä¹ˆæ—¶å€™æ¥æ”¶åˆ°æ¶ˆæ¯ï¼Ÿ</strong></li><li><strong>å¸¸å¸¸å¬è¯´çš„ MessageQueue åˆ°å“ªå»äº†ï¼Ÿ</strong></li><li><strong>Handler æ˜¯å¦‚ä½•ä¿è¯æ‰€åœ¨çš„è¿è¡Œçº¿ç¨‹çš„ï¼Œçº¿ç¨‹åˆæ˜¯å¦‚ä½•åˆ‡æ¢çš„ï¼Ÿ</strong></li></ol><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬ä¸€èµ·è¿›å…¥æºç çš„ä¸–ç•Œæ¥ä¸€ä¸€è§£å¼€è¿™äº›ç–‘æƒ‘ã€‚</p><h2 id="ä¸‰ã€Handler-æºç æµ…æ"><a href="#ä¸‰ã€Handler-æºç æµ…æ" class="headerlink" title="ä¸‰ã€Handler æºç æµ…æ"></a>ä¸‰ã€Handler æºç æµ…æ</h2><blockquote><p>æ³¨ï¼šåŸºäº Android SDK 28 è¿›è¡Œè§£æã€‚æ¶‰åŠåˆ°çš„ä»£ç ä¼šåšç®€åŒ–å¤„ç†ï¼Œåªä¿ç•™å…³é”®éƒ¨åˆ†çš„ä»£ç ã€‚</p></blockquote><p>å…ˆè¯´ä¸€ä¸‹æœ¬ç¯‡æ–‡ç« é˜…è¯»æºç çš„é¡ºåºï¼Œå…ˆçœ‹çœ‹ Handler å®ä¾‹åŒ–è¿‡ç¨‹ä¸­åšå“ªäº›åˆå§‹åŒ–æ“ä½œï¼Œç„¶å <code>send</code> å’Œ <code>post</code> ä¹‹ååˆæ˜¯å°† Message å‘é€ç»™è°ï¼Œä¹‹åçš„æµç¨‹åˆæ˜¯æ€æ ·ï¼ŒåŒæ—¶åœ¨é˜…è¯»è¿‡ç¨‹ä¸­æ¥è§£ç­”ä¸Šä¸€èŠ‚çš„ç–‘é—®ã€‚</p><h3 id="3-1-Handler-å®ä¾‹åŒ–"><a href="#3-1-Handler-å®ä¾‹åŒ–" class="headerlink" title="3.1 Handler å®ä¾‹åŒ–"></a>3.1 Handler å®ä¾‹åŒ–</h3><p>åœ¨è·Ÿè¿› Handler çš„æ„é€ æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬ä¼šå‘ç° Handler åœ¨å®ä¾‹åŒ–æ—¶ä¼šä¸ºä¸‰ä¸ªå±æ€§èµ‹å€¼ï¼š</p><ol><li>ç¬¬ä¸€ä¸ªæ˜¯ <code>mLooper</code> é€šè¿‡ <code>Looper.myLooper()</code> å–å€¼ï¼ŒåŒæ—¶æ£€æŸ¥ Looper æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºæ—¶æŠ›å‡ºå¼‚å¸¸ï¼›</li><li>ç¬¬äºŒä¸ªæ˜¯ <code>mQueue</code> è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬å¿ƒå¿ƒå¿µå¿µçš„ MessageQueueï¼Œå¯ä»¥å‘ç°å®ƒæ˜¯ç”± Looper æŒæœ‰çš„ï¼Œå…·ä½“çš„è§£æçœ‹ä¸‹ä¸€èŠ‚ã€<strong>Message ç®¡ç†ä¸åˆ†å‘</strong>ã€‘ï¼›</li><li>è¿˜æœ‰ä¸ªæ˜¯ <code>mCallback</code> ï¼Œè¿™ä¸ªç›¸å…³è§£æå¯ä»¥çœ‹ä¸‹ä¸€èŠ‚ã€<strong>Message ç®¡ç†ä¸åˆ†å‘</strong>ã€‘ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Handler.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Handler</span><span class="params">(Callback callback, <span class="keyword">boolean</span> async)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...çœç•¥äº†éƒ¨åˆ†ä»£ç ï¼Œåç»­çœ‹åˆ° //... è¿™ä¸ªå°±ä»£è¡¨ç®€ç•¥äº†ä»£ç </span></span><br><span class="line">    mLooper = Looper.myLooper();</span><br><span class="line">    <span class="keyword">if</span> (mLooper == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">"Can't create handler inside thread "</span> + Thread.currentThread()</span><br><span class="line">                    + <span class="string">" that has not called Looper.prepare()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mQueue = mLooper.mQueue;</span><br><span class="line">    mCallback = callback;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•ä¸­å…¶å®æ²¡æœ‰å¤ªå¤šçš„ä¸œè¥¿ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹ <code>Looper.myLooper()</code> æ˜¯å¦‚ä½•è·å–åˆ° Looper å®ä¾‹çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Looper.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="meta">@Nullable</span> <span class="function">Looper <span class="title">myLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sThreadLocal.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾ˆç®€å•ï¼Œé€šè¿‡ <code>ThreadLocal.get()</code> è·å–ï¼Œæ—¢ç„¶æœ‰ <code>get</code> é‚£ä¹ˆè‚¯å®šæœ‰å¯¹åº”çš„ <code>set</code> æ–¹æ³•ï¼Œé‚£åœ¨ä»€ä¹ˆåœ°æ–¹ set å‘¢ï¼Ÿ</p><p>è¿™æ—¶å€™æˆ‘ä»¬å°±è¦å›æƒ³ä¸€ä¸‹ï¼Œåœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨ Handler æ˜¯æœ‰ä¸‰ä¸ªæ­¥éª¤çš„ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> Looper.<span class="keyword">prepare</span>()</span><br><span class="line"><span class="number">2.</span> var <span class="keyword">handler</span>: <span class="keyword">Handler</span> = <span class="keyword">Handler</span>()</span><br><span class="line"><span class="number">3.</span> Looper.<span class="keyword">loop</span>()</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ­¤æ—¶æ˜¯åœ¨ç¬¬ 2 ä¸­ï¼Œé‚£ <code>ThreadLocal.set()</code> çš„è®¾ç½®æ˜¯ä¸æ˜¯åœ¨ <code>Looper.prepare()</code> ä¸­å‘¢ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Looper.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sThreadLocal.get() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Only one Looper may be created per thread"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sThreadLocal.set(<span class="keyword">new</span> Looper(quitAllowed));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Looper</span><span class="params">(<span class="keyword">boolean</span> quitAllowed)</span> </span>&#123;</span><br><span class="line">    mQueue = <span class="keyword">new</span> MessageQueue(quitAllowed);</span><br><span class="line">    mThread = Thread.currentThread();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯«æ— ç–‘é—®ï¼Œæ˜¯çš„ã€‚</p><p>è¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªå°å°ç»“è®ºï¼šLooper æä¾›ä¸€ä¸ª <code>Looper.prepare()</code> æ–¹æ³•æ¥åˆ›å»º Looper å¯¹è±¡ï¼Œå¹¶å°†è¯¥å¯¹è±¡æ”¾åˆ° ThreadLocal ä¸­ï¼Œç­‰ Handler å®ä¾‹åŒ–çš„æ—¶å€™å–å‡ºè¯¥ Looper å®ä¾‹ã€‚</p><p>é‚£ ThreadLocal åˆæ˜¯ä»€ä¹ˆï¼Œæ€ä¹ˆä¿è¯ Handler å®ä¾‹åŒ–è·å–çš„ Looper æ­£å¥½æ˜¯æˆ‘ä»¬åˆ›å»ºçš„é‚£ä¸ªå‘¢ï¼Ÿ</p><p><strong>ThreadLocalï¼šçº¿ç¨‹æœ¬åœ°å­˜å‚¨åŒºï¼ˆThread Local Storageï¼‰,æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ç§æœ‰çš„æœ¬åœ°å­˜å‚¨åŒºåŸŸï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´å½¼æ­¤ä¸èƒ½è®¿é—®å¯¹æ–¹çš„æœ¬åœ°å­˜å‚¨åŒºã€‚</strong></p><p>æœ‰ä¸ª ThreadLocal æ¦‚å¿µä¹‹åï¼Œæ¥ä¸‹æ¥çœ‹çœ‹ <code>ThreadLocal.set()</code> åšäº†å“ªäº›å¤„ç†ã€‚</p><blockquote><p>æ³¨ï¼šè¿™è¾¹çš„æ³›å‹ T æŒ‡çš„æ˜¯ Looper ç±»å‹</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ThreadLocal.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>)</span><br><span class="line">        map.set(<span class="keyword">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createMap</span><span class="params">(Thread t, T firstValue)</span> </span>&#123;</span><br><span class="line">    t.threadLocals = <span class="keyword">new</span> ThreadLocalMap(<span class="keyword">this</span>, firstValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° ThreadLocal å†…éƒ¨é€šè¿‡ä¸€ä¸ª ThreadLocalMap é”®å€¼å¯¹æ¥ä¿å­˜ Looper å®ä¾‹ï¼ŒåŒæ—¶è¿™ä¸ª Map ä¿å­˜åœ¨å½“å‰çº¿ç¨‹ä¸­ã€‚</p><p>å†æ¥çœ‹çœ‹ <code>ThreadLocal.get()</code> ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ThreadLocal.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Thread t = Thread.currentThread();</span><br><span class="line">    ThreadLocalMap map = getMap(t);</span><br><span class="line">    <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ThreadLocalMap.Entry e = map.getEntry(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            T result = (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ThreadLocalMap <span class="title">getMap</span><span class="params">(Thread t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œè·å– Looper å®ä¾‹æ—¶ä¹Ÿæ˜¯å…ˆä»å½“å‰çº¿ç¨‹ä¸­å…ˆè·å– ThreadLocalMapï¼Œå†æ ¹æ®å½“å‰ ThreadLocal å¯¹è±¡ä½œä¸º key æ¥è·å–å¯¹åº”çš„ Looper å®ä¾‹ã€‚</p><p>é€šè¿‡ ThreadLocal çš„ <code>set</code> å’Œ <code>get</code> æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒæ¸…æ™°çš„å‘ç°åœ¨ Handler å½“ä¸­ï¼šThreadLocal æ˜¯ç”¨æ¥å®ç° Thread å’Œ Looper çš„å…³è”çš„ã€‚</p><p>ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬ç°åœ¨å°±å¯ä»¥æ¥è§£ç­”ã€<strong>ç–‘é—® 1</strong>ã€‘ï¼ˆä¸ºå•¥åœ¨å­çº¿ç¨‹éœ€è¦è°ƒç”¨ <code>Looper.prepare()</code> ç­‰æ–¹å¼è€Œä¸»çº¿ç¨‹å´ä¸éœ€è¦ï¼Ÿï¼‰ï¼š<strong>åœ¨ Handler å®ä¾‹åŒ–ä¸­ä¼šè°ƒç”¨ <code>Looper.myLooper()</code> è·å– Looper å®ä¾‹å¯¹è±¡ï¼Œç„¶è€Œæ­¤å¯¹è±¡æœ€ç»ˆæ˜¯ä¿å­˜åœ¨å½“å‰çº¿ç¨‹çš„ ThreadLocalMap ä¸­çš„ï¼Œå¦‚æœåœ¨ Handler å®ä¾‹åŒ–ä¹‹å‰ä¸å…ˆè°ƒç”¨ <code>Looper.prepare()</code> æ¥åˆ›å»ºå¯¹åº”çš„ Looper å®ä¾‹ï¼Œé‚£ä¹ˆ <code>Looper.myLooper()</code> è·å–åˆ°çš„æ˜¯ä¸€ä¸ª <code>null</code> å€¼ï¼Œè¿™å°±ä¼šå¯¼è‡´åœ¨æ£€æµ‹ <code>mLooper</code> æ˜¯å¦ä¸ºç©ºæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚</strong></p><p>å› æ­¤æˆ‘ä»¬å¯ä»¥å¾—å‡ºè¿™ä¹ˆä¸€ä¸ªç»“è®ºï¼š<strong>åœ¨ä»»æ„ä¸€ä¸ªçº¿ç¨‹ä¸­è¦å®ä¾‹åŒ– Handler å¿…é¡»è¦å…ˆè°ƒç”¨ <code>Looper.prepare()</code>  æ¥ä¼˜å…ˆåˆ›å»º Looper ä¿è¯å½“å‰çº¿ç¨‹ä¸­æœ‰ä¸€ä¸ª Looper å®ä¾‹ï¼Œå¦åˆ™å°±ä¼šæŠ›å¼‚å¸¸ã€‚</strong></p><p>è¿™æ—¶ï¼Œç»†å¿ƒçš„ä½ ä¼šè¯´ï¼Œè¿™ä¸ªç»“è®ºä¸å¯¹å•Šï¼Œä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä½¿ç”¨ Handler å°±ä¸ç”¨è°ƒç”¨ <code>Looper.prepare()</code>  å‘¢ï¼Ÿ</p><p>ç¡®å®æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨ Handler çš„æ—¶å€™å¹¶æ²¡æœ‰åšé¢å¤–çš„åˆ›å»º Looper å·¥ä½œï¼Œé‚£ä¸»çº¿ç¨‹éš¾é“å°±æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹ï¼Œå°±å¯ä»¥ä¸ç”¨åˆ›å»ºä¸€ä¸ª Looper å®ä¾‹å—ï¼Ÿå…¶å®å¹¶ä¸æ˜¯çš„ï¼Œä¸»çº¿ç¨‹ä¹Ÿä¸ä¾‹å¤–ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Œé‚£æ˜¯å› ä¸º ActivityThreadã€‚</p><p>é€šå¸¸æˆ‘ä»¬è®¤ä¸º ActivityThread å°±æ˜¯ä¸»çº¿ç¨‹ä¹Ÿå¯ä»¥è¯´æ˜¯ UI çº¿ç¨‹ï¼Œä½†å…¶å®å®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œæ˜¯ä¸»çº¿ç¨‹æ“ä½œçš„ä¸€ä¸ªç®¡ç†è€…ï¼Œè®¤ä¸ºå®ƒæ˜¯ä¸»çº¿ç¨‹ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ActivityThread ä¸­çš„æœ‰ä¸ª <code>main()</code> æ–¹æ³•å®ƒæ˜¯ APP çš„å…¥å£ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ActivityThread.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...    </span></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>, startSeq);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...    </span></span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Looper.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prepareMainLooper</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    prepare(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (Looper<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sMainLooper != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The main Looper has already been prepared."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        sMainLooper = myLooper();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°åœ¨ <strong>ActivityThread çš„ <code>main()</code> æ–¹æ³•ä¸­è°ƒç”¨äº† <code>Looper.prepareMainLooper()</code> åˆ›å»ºäº†å±äºä¸»çº¿ç¨‹çš„ Looperï¼Œå› æ­¤æˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­ç›´æ¥ä½¿ç”¨ Handlerã€‚</strong></p><h3 id="3-2-Message-ç®¡ç†ä¸åˆ†å‘"><a href="#3-2-Message-ç®¡ç†ä¸åˆ†å‘" class="headerlink" title="3.2 Message ç®¡ç†ä¸åˆ†å‘"></a>3.2 Message ç®¡ç†ä¸åˆ†å‘</h3><p>åœ¨ã€<strong>Handler åŸºæœ¬ç”¨æ³•</strong>ã€‘ä¸­å¯ä»¥å‘ç°æ¶ˆæ¯æ˜¯é€šè¿‡ <code>sendMessage()</code> å’Œ <code>post()</code> æ¥å‘é€çš„ï¼Œä½†å…¶å® Handler æä¾›äº†  <code>send</code> å’Œ <code>post</code> ä¸ºå¼€å¤´çš„ä¸€ç³»åˆ—æ–¹æ³•ã€‚</p><p>è·Ÿè¿›ä»£ç ä¹‹åï¼Œæˆ‘ä»¬ä¼šå‘ç°å…¶å®è¿™ç³»åˆ—çš„æ–¹æ³•æœ€ç»ˆéƒ½ä¼šèµ°åˆ° <code>Handler().enqueueMessage()</code> æ–¹æ³•ä¸­ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Handler.java</span></span><br><span class="line">send<span class="constructor">Message(Message <span class="params">msg</span>)</span></span><br><span class="line"> -&gt; send<span class="constructor">MessageDelayed(Message <span class="params">msg</span>, <span class="params">long</span> <span class="params">delayMillis</span>)</span></span><br><span class="line">  -&gt; send<span class="constructor">MessageAtTime(Message <span class="params">msg</span>, <span class="params">long</span> <span class="params">uptimeMillis</span>)</span></span><br><span class="line">   -&gt; enqueue<span class="constructor">Message(MessageQueue <span class="params">queue</span>, Message <span class="params">msg</span>, <span class="params">long</span> <span class="params">uptimeMillis</span>)</span></span><br></pre></td></tr></table></figure><p><strong><code>post</code> è™½ç„¶å‚æ•°æ˜¯ Runnable ä½†æœ€ç»ˆä¹Ÿæ˜¯ä¸€ä¸ª Messageã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Handler.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">post</span><span class="params">(Runnable r)</span></span>&#123;</span><br><span class="line">   <span class="keyword">return</span>  sendMessageDelayed(getPostMessage(r), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Message <span class="title">getPostMessage</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">    Message m = Message.obtain();</span><br><span class="line">    m.callback = r;</span><br><span class="line">    <span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥è¯¦ç»†çœ‹ä¸‹ <code>Handler().enqueueMessage()</code> çš„æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Handler.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(MessageQueue queue, Message msg, <span class="keyword">long</span> uptimeMillis)</span> </span>&#123;</span><br><span class="line">    msg.target = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (mAsynchronous) &#123;</span><br><span class="line">        msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> queue.enqueueMessage(msg, uptimeMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç° MessageQueue åœ¨è¿™é‡Œåˆå‡ºç°ï¼Œåœ¨å‰é¢ã€<strong>Handler å®ä¾‹åŒ–</strong>ã€‘ä¸­å‡ºç°äº†ä¸¤æ¬¡ï¼Œä¸€æ¬¡æ˜¯åœ¨åˆå§‹åŒ– Handler çš„æ—¶å€™é€šè¿‡ <code>mLooper.mQueue</code> è¿›è¡Œèµ‹å€¼ï¼Œå¦ä¸€æ¬¡æ˜¯åœ¨ Looper åˆå§‹åŒ–ä¸­åˆ›å»ºäº† MessageQueue çš„å¯¹è±¡ã€‚</p><p><strong>MessageQueue é¡¾åæ€ä¹‰æ˜¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè´Ÿè´£æ¶ˆæ¯çš„å…¥é˜Ÿå‡ºé˜Ÿã€‚å†…éƒ¨æ˜¯ä¸€ä¸ªå•é“¾è¡¨ã€‚</strong></p><p>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯è°ƒç”¨ <code>queue.enqueueMessage</code> å¯¹æ¶ˆæ¯è¿›è¡Œäº†å…¥é˜Ÿå¤„ç†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ <code>msg.target = this</code> è¿™ä¸ªåé¢è§£æä¼šä½¿ç”¨åˆ°ï¼Œå…ˆè®°ç€ã€‚</p><p>æˆ‘ä»¬æ¥ç€å¾€ä¸‹è·Ÿ <code>MessageQueue.enqueueMessage()</code> ï¼Œçœ‹çœ‹æ¶ˆæ¯æ˜¯å¦‚ä½•æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MessageQueue.java</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">enqueueMessage</span><span class="params">(Message msg, <span class="keyword">long</span> when)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.target == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Message must have a target."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (msg.isInUse()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(msg + <span class="string">" This message is already in use."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">            msg.recycle();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        msg.markInUse();</span><br><span class="line">        msg.when = when;</span><br><span class="line">        Message p = mMessages;</span><br><span class="line">        <span class="keyword">boolean</span> needWake;</span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span> || when == <span class="number">0</span> || when &lt; p.when) &#123;</span><br><span class="line">            <span class="comment">// New head, wake up the event queue if blocked.</span></span><br><span class="line">            msg.next = p;</span><br><span class="line">            mMessages = msg;</span><br><span class="line">            needWake = mBlocked;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Inserted within the middle of the queue.  Usually we don't have to wake</span></span><br><span class="line">            <span class="comment">// up the event queue unless there is a barrier at the head of the queue</span></span><br><span class="line">            <span class="comment">// and the message is the earliest asynchronous message in the queue.</span></span><br><span class="line">            needWake = mBlocked &amp;&amp; p.target == <span class="keyword">null</span> &amp;&amp; msg.isAsynchronous();</span><br><span class="line">            Message prev;</span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                prev = p;</span><br><span class="line">                p = p.next;</span><br><span class="line">                <span class="keyword">if</span> (p == <span class="keyword">null</span> || when &lt; p.when) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (needWake &amp;&amp; p.isAsynchronous()) &#123;</span><br><span class="line">                    needWake = <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            msg.next = p; <span class="comment">// invariant: p == prev.next</span></span><br><span class="line">            prev.next = msg;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We can assume mPtr != 0 because mQuitting is false.</span></span><br><span class="line">        <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">            nativeWake(mPtr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç è™½ç„¶çœ‹èµ·æ¥æœ‰ç‚¹é•¿ï¼Œä½†é€»è¾‘è¿˜æ˜¯å¾ˆæ¸…æ™°çš„ï¼Œè¿™é‡Œå°±ä¸ä¸€ä¸€è§£é‡Šã€‚å¯ä»¥å‘ç°<strong>MessageQueue æ˜¯ä¸€ä¸ªæŒ‰ç…§ Message è§¦å‘æ—¶é—´ï¼ˆ<code>when</code> çš„å¤§å°ï¼‰çš„å…ˆåé¡ºåºæ’åºçš„ï¼Œé˜Ÿå¤´æ˜¯æœ€æ—©è¦è§¦å‘çš„æ¶ˆæ¯ã€‚å› æ­¤å½“ä¸€ä¸ªæ¶ˆæ¯è¦è¿›å…¥é˜Ÿåˆ—çš„æ—¶å€™ï¼Œä¼šä»å¤´å¼€å§‹å¼€å§‹éå†ï¼Œç›´åˆ°æ‰¾åˆ°è¯¥æ¶ˆæ¯åˆé€‚çš„æ’å…¥ä½ç½®ï¼Œæ¥ä¿è¯æ•´ä¸ªé˜Ÿåˆ—æ¶ˆæ¯çš„æ—¶é—´é¡ºåº</strong>ã€‚</p><p>åˆ°è¿™é‡Œæˆ‘ä»¬å·²ç»æ¸…æ¥šçš„çŸ¥é“ï¼ŒHandler <code>send</code> æˆ– <code>post</code> æ¶ˆæ¯ä¹‹åæ˜¯ç”± MessageQueue æŒ‰ç…§æ—¶é—´é¡ºåºæ¥å­˜å‚¨ Message çš„ï¼Œé‚£ Message åˆæ˜¯ä½•æ—¶ç”±è°æ¥è§¦å‘çš„å‘¢ï¼Ÿ</p><p>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å°±è¦å…ˆå›é¡¾ä¸€ä¸‹ï¼Œçº¿ç¨‹ä½¿ç”¨ Handler çš„ä¸‰ä¸ªæ­¥éª¤ï¼š</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> Looper.<span class="keyword">prepare</span>()</span><br><span class="line"><span class="number">2.</span> var <span class="keyword">handler</span>: <span class="keyword">Handler</span> = <span class="keyword">Handler</span>()</span><br><span class="line"><span class="number">3.</span> Looper.<span class="keyword">loop</span>()</span><br></pre></td></tr></table></figure><p>åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬å·²ç»è§£æäº† 1ã€2 ä¸¤ä¸ªæ­¥éª¤ï¼Œé‚£ <code>Looper.loop()</code> è¿™ä¸ªæ–¹æ³•æ˜¯ä¸æ˜¯ç”¨æ¥åˆ†å‘ Message çš„å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Looper.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Looper me = myLooper();</span><br><span class="line">    <span class="keyword">if</span> (me == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"No Looper; Looper.prepare() wasn't called on this thread."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> MessageQueue queue = me.mQueue;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        Message msg = queue.next(); <span class="comment">// might block</span></span><br><span class="line">        <span class="keyword">if</span> (msg == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// No message indicates that the message queue is quitting.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            msg.target.dispatchMessage(msg);</span><br><span class="line">            dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">        msg.recycleUnchecked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°ï¼Œ<code>Looper.loop()</code> ç¡®å®ç”¨æ¥åˆ†å‘ Message çš„ã€‚è¿›å…¥ <code>loop</code> ä¹‹åä¼šæœ‰ä¸ª for çš„æ— é™å¾ªç¯ï¼Œåœ¨è¿™ä¸ªå¾ªç¯å½“ä¸­ï¼Œ<strong>é¦–å…ˆä» MessageQueue ä¸­è¯»å–ä¸‹ä¸€æ¡ Messageï¼Œç„¶åå°† Message åˆ†å‘ç»™å¯¹åº”çš„ <code>target</code> å¤„ç†ï¼Œæœ€åå°†è¯¥ Message å›æ”¶åˆ°æ¶ˆæ¯æ± æ–¹ä¾¿å¤ç”¨ï¼Œä¸æ–­çš„é‡å¤ä»¥ä¸Šä¸‰ä¸ªæ­¥éª¤ï¼Œç›´åˆ°æ²¡æœ‰æ¶ˆæ¯æ—¶é€€å‡ºå¾ªç¯</strong>ã€‚</p><p>æ¥ç€æˆ‘ä»¬çœ‹çœ‹ <code>queue.next()</code> åˆ°åº•å¦‚ä½•è¯»å– Message çš„ï¼ŒåŒæ—¶è¿™è¾¹è¿˜æœ‰ä¸ªæ³¨é‡Š <code>might block ï¼ˆå¯èƒ½é˜»å¡ï¼‰</code>ï¼Œä¸€èµ·çœ‹çœ‹åˆ°åº•æ€ä¹ˆå›äº‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MessageQueue.java</span></span><br><span class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">int</span> pendingIdleHandlerCount = -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></span><br><span class="line">    <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextPollTimeoutMillis != <span class="number">0</span>) &#123;</span><br><span class="line">            Binder.flushPendingCommands();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//é˜»å¡æ“ä½œï¼Œç­‰å¾… nextPollTimeoutMillis æ—¶é•¿æˆ–è€…æ¶ˆæ¯é˜Ÿåˆ—è¢«å”¤é†’æ—¶ä¼šè¿”å›ï¼Œæ˜¯ä¸€ä¸ª native æ–¹æ³•</span></span><br><span class="line">        nativePollOnce(ptr, nextPollTimeoutMillis);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// Try to retrieve the next message.  Return if found.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">            Message prevMsg = <span class="keyword">null</span>;</span><br><span class="line">            Message msg = mMessages;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (now &lt; msg.when) &#123;</span><br><span class="line">                    <span class="comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span></span><br><span class="line">                    nextPollTimeoutMillis = (<span class="keyword">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Got a message.</span></span><br><span class="line">                    mBlocked = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">if</span> (prevMsg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        prevMsg.next = msg.next;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mMessages = msg.next;</span><br><span class="line">                    &#125;</span><br><span class="line">                    msg.next = <span class="keyword">null</span>;</span><br><span class="line">                    msg.markInUse();</span><br><span class="line">                    <span class="keyword">return</span> msg;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// No more messages.</span></span><br><span class="line">                nextPollTimeoutMillis = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Process the quit message now that all pending messages have been handled.</span></span><br><span class="line">            <span class="keyword">if</span> (mQuitting) &#123;</span><br><span class="line">                dispose();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Run the idle handlers.</span></span><br><span class="line">        <span class="comment">// ... å…³äº IdleHandler å¯ä»¥åœ¨ [å››ã€Handler æ‰©å±•] ä¸­æŸ¥çœ‹</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé¢æœ‰ä¸ª <code>nativePollOnce()</code> çš„ native çš„é˜»å¡æ“ä½œï¼Œ<code>nextPollTimeoutMillis</code> æ˜¯æŒ‡é˜»å¡çš„æ—¶é•¿ï¼Œå½“ <code>nextPollTimeoutMillis = -1</code> æ—¶ä»£è¡¨æ­¤æ—¶æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œä¼šä¸€ç›´ç­‰å¾…ä¸‹å»ã€‚<strong>å¯ä»¥å‘ç°å»¶æ—¶æ¶ˆæ¯å°±æ˜¯åœ¨è¿™é‡Œå®ç°çš„ã€‚</strong></p><p>å…³äºé˜»å¡è¿˜æœ‰ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä»£ç å¯ä»¥çŸ¥é“ <code>Looper.loop()</code> å†…éƒ¨æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ï¼Œé‚£ä¹ˆå®ƒä¸ºä»€ä¹ˆä¸ä¼šå¡æ­»å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆå¯ä»¥æŸ¥çœ‹ ã€*<em>å…­ã€å‚è€ƒä¸æ¨è 1 *</em>ã€‘çš„æ–‡ç« ã€‚</p><p>çœ‹å®Œ  <code>queue.next()</code> æ¶ˆæ¯çš„è¯»å–ï¼Œæ¥ä¸‹æ¥æ¥çœ‹çœ‹ <code>msg.target.dispatchMessage(msg)</code> ï¼Œè¿™é‡Œçš„ <code>target</code> æ˜¯ä¸€ä¸ª Handler æ˜¯å¦è¿˜è®°å¾—å‘¢ï¼Œåœ¨  <code>Handler().enqueueMessage()</code>  æ¶ˆæ¯å…¥é˜Ÿä¹‹å‰ä¼šå°†å½“å‰ Handler å¯¹è±¡èµ‹å€¼ç»™ <code>Message.target</code> ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Handler.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatchMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">        handleCallback(msg);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mCallback.handleMessage(msg)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        handleMessage(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleCallback</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">    message.callback.run();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Subclasses must implement this to receive messages.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶ˆæ¯åˆ†å‘æµç¨‹ï¼š</p><ol><li>å½“ Message.callback ä¸ä¸ºç©ºæ—¶ï¼Œå›è°ƒ  message.callback.run() æ–¹æ³•ï¼Œå…¶ä¸­ callback çš„ç±»å‹æ˜¯ Runnable ç±»å‹ï¼Œå½“ä½ ä½¿ç”¨ Handler.post ç³»åˆ—æ–¹æ³•æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨ï¼›å¦‚æœ Message.callback ä¸ºç©ºè¿›å…¥æµç¨‹ 2ã€‚</li><li>å¦‚æœ Handler.mCallback ä¸ä¼šç©ºåˆ™å…ˆè°ƒç”¨ mCallback.handleMessage(msg)ï¼Œå¦åˆ™è¿›å…¥æµç¨‹ 3ã€‚æ³¨æ„ï¼šè‹¥ mCallback.handleMessage(msg) è¿”å› trueï¼Œæ•´ä¸ªæµç¨‹åˆ°æ­¤ä¸ºæ­¢ã€‚</li><li>æœ€åï¼Œè°ƒç”¨ Handler è‡ªèº«çš„ handleMessage() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ºç©ºå®ç°éœ€è¦å­ç±»è¦†å†™ã€‚</li></ol><p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆä» Handler.send() å‘é€æ¶ˆæ¯å¼€å§‹åˆ°æœ€å Handler æ¥æ”¶å¹¶å¤„ç†æ¶ˆæ¯çš„æ•´ä½“æµç¨‹çš„è§£æï¼ŒåŒæ—¶ä¹Ÿåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­è§£ç­”äº†ã€<strong>ç–‘é—® 2ã€3</strong>ã€‘ã€‚</p><p>é‚£è¿˜æœ‰æœ€åä¸€ä¸ªç–‘é—®ï¼ŒHandler æ˜¯å¦‚ä½•çº¿ç¨‹åˆ‡æ¢çš„å‘¢ï¼Ÿ</p><p>æ³¨ï¼šåŸå…ˆæƒ³æŒ‰ç…§è‡ªå·±çš„æ€è·¯æè¿°ï¼Œä½†å†™å®Œä¹‹åå‘ç°ä¸å¤Ÿç®€æ´ï¼Œå› æ­¤åœ¨è¿™é‡Œå¼•ç”¨äº†ã€<strong>å…­ã€å‚è€ƒä¸æ¨è 3</strong>ã€‘æ–‡ç« ä¸­æè¿°ã€‚</p><p>å¾ˆå¤šäººæä¸æ‡‚è¿™ä¸ªåŸç†ï¼Œä½†æ˜¯å…¶å®éå¸¸ç®€å•ï¼Œæˆ‘ä»¬å°†æ‰€æ¶‰åŠçš„æ–¹æ³•è°ƒç”¨æ ˆç”»å‡ºæ¥ï¼Œå¦‚ä¸‹ï¼š</p> <figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Thread &#123;</span><br><span class="line">Looper.<span class="keyword">loop</span>()</span><br><span class="line"><span class="function"> -&gt;</span> MessageQueue.next()</span><br><span class="line"><span class="function">   -&gt;</span> Message.target.dispatchMessage()</span><br><span class="line"><span class="function">    -&gt;</span> Handler.handleMessage()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ˜¾è€Œæ˜“è§ï¼ŒHandler.handleMessage() æ‰€åœ¨çš„çº¿ç¨‹æœ€ç»ˆç”±è°ƒç”¨ Looper.loop() çš„çº¿ç¨‹æ‰€å†³å®šã€‚</strong></p><p>å¹³æ—¶æˆ‘ä»¬ç”¨çš„æ—¶å€™ä»å¼‚æ­¥çº¿ç¨‹å‘é€æ¶ˆæ¯åˆ° Handlerï¼Œè¿™ä¸ª Handler çš„ <code>handleMessage()</code> æ–¹æ³•æ˜¯åœ¨ä¸»çº¿ç¨‹è°ƒç”¨çš„ï¼Œæ‰€ä»¥æ¶ˆæ¯å°±ä»å¼‚æ­¥çº¿ç¨‹åˆ‡æ¢åˆ°äº†ä¸»çº¿ç¨‹ã€‚</p><h2 id="å››ã€Handler-æ‰©å±•"><a href="#å››ã€Handler-æ‰©å±•" class="headerlink" title="å››ã€Handler æ‰©å±•"></a>å››ã€Handler æ‰©å±•</h2><h3 id="4-1-IdleHandler"><a href="#4-1-IdleHandler" class="headerlink" title="4.1 IdleHandler"></a>4.1 IdleHandler</h3><p>IdleHandler ç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªæ¥å£ï¼Œåªä¸è¿‡å®ƒåœ¨ Handler å½“ä¸­ä»…ä»…ä¼šåœ¨æ¶ˆæ¯ç©ºé—²çš„æ—¶å€™æ‰§è¡Œã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MessageQueue.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">IdleHandler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">queueIdle</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ‰§è¡Œçš„ä»£ç åœ¨ <code>MessageQueue.next()</code> æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MessageQueue.java</span></span><br><span class="line"><span class="function">Message <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">    <span class="keyword">int</span> pendingIdleHandlerCount = -<span class="number">1</span>; <span class="comment">// -1 only during first iteration</span></span><br><span class="line">    <span class="keyword">int</span> nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// If first time idle, then get the number of idlers to run.</span></span><br><span class="line">            <span class="comment">// Idle handles only run if the queue is empty or if the first message</span></span><br><span class="line">            <span class="comment">// in the queue (possibly a barrier) is due to be handled in the future.</span></span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; (mMessages == <span class="keyword">null</span> || now &lt; mMessages.when)) &#123;</span><br><span class="line">                pendingIdleHandlerCount = mIdleHandlers.size();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// No idle handlers to run.  Loop and wait some more.</span></span><br><span class="line">                mBlocked = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mPendingIdleHandlers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPendingIdleHandlers = <span class="keyword">new</span> IdleHandler[Math.max(pendingIdleHandlerCount, <span class="number">4</span>)];</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Run the idle handlers.</span></span><br><span class="line">        <span class="comment">// We only ever reach this code block during the first iteration.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pendingIdleHandlerCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> IdleHandler idler = mPendingIdleHandlers[i];</span><br><span class="line">            mPendingIdleHandlers[i] = <span class="keyword">null</span>; <span class="comment">// release the reference to the handler</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> keep = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                keep = idler.queueIdle();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">"IdleHandler threw exception"</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!keep) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    mIdleHandlers.remove(idler);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Reset the idle handler count to 0 so we do not run them again.</span></span><br><span class="line">        pendingIdleHandlerCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// While calling an idle handler, a new message could have been delivered</span></span><br><span class="line">        <span class="comment">// so go back and look again for a pending message without waiting.</span></span><br><span class="line">        nextPollTimeoutMillis = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="äº”ã€æ€»ç»“"><a href="#äº”ã€æ€»ç»“" class="headerlink" title="äº”ã€æ€»ç»“"></a>äº”ã€æ€»ç»“</h2><p>æœ€åï¼Œæˆ‘ä»¬ç»“åˆå›¾ç‰‡æ¥å°è¯•å¯¹ Handler åšä¸ªæ€»ç»“ã€‚</p><blockquote><p>å›¾ç‰‡æ¥æºã€<strong>å…­ã€å‚è€ƒä¸æ¨è 2</strong>ã€‘</p></blockquote><p><img src="/2019/11/26/Android-handler-source-code-analysis/handler_architecture.jpg" alt="handler_architecture"></p><p><img src="/2019/11/26/Android-handler-source-code-analysis/handler_process.jpg" alt="handler_process"></p><ul><li>Looperï¼šä¸æ–­çš„æ‰§è¡Œå¾ªç¯ï¼ˆ<code>Looper.loop()</code>ï¼‰ä»æŒæœ‰çš„ MessageQueue é˜Ÿåˆ—ä¸­è¯»å– Message ï¼ˆ<code>MessageQueue.next()</code>ï¼‰ï¼Œåˆ†å‘ç»™å¯¹åº”çš„ Handler å¤„ç†ï¼›</li><li>MessageQueueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œé€šè¿‡ <code>MessageQueue.enqueueMessage()</code> æ–¹æ³•å¯¹ä» Handler å‘é€è¿‡æ¥çš„ Message è¿›è¡Œå…¥é˜Ÿå­˜å‚¨ã€‚</li><li>Handlerï¼šæ¶ˆæ¯è¾…åŠ©ç±»ï¼Œè´Ÿè´£å‘é€å’Œå¤„ç† Messageã€‚</li></ul><p>ç®€å•ä¸€å¥è¯æ¦‚æ‹¬ï¼š<strong>Handler é€šè¿‡ sendMessage() å‘é€ Message åˆ° MessageQueue é˜Ÿåˆ—ä¸­ï¼Œå¹¶ç”± Looper é€šè¿‡ loop() ä¸æ–­å¾ªç¯ä» MessageQueue ä¸­è¯»å– Messageï¼Œå°†å…¶é€šè¿‡ Message.target.dispatchMessage() äº¤ç»™ Handler å¤„ç†ã€‚</strong></p><h2 id="å…­ã€å‚è€ƒä¸æ¨è"><a href="#å…­ã€å‚è€ƒä¸æ¨è" class="headerlink" title="å…­ã€å‚è€ƒä¸æ¨è"></a>å…­ã€å‚è€ƒä¸æ¨è</h2><ol><li><a href="https://www.zhihu.com/question/34652589/answer/90344494" target="_blank" rel="noopener">Android ä¸­ä¸ºä»€ä¹ˆä¸»çº¿ç¨‹ä¸ä¼šå› ä¸º Looper.loop() é‡Œçš„æ­»å¾ªç¯å¡æ­»</a></li><li><a href="http://gityuan.com/2015/12/26/handler-message-framework/" target="_blank" rel="noopener">Androidæ¶ˆæ¯æœºåˆ¶1-Handlerï¼ˆJava å±‚ï¼‰</a></li><li><a href="https://juejin.im/post/5c74b64a6fb9a049be5e22fc#heading-0" target="_blank" rel="noopener">Handler éƒ½æ²¡ææ‡‚ï¼Œæ‹¿ä»€ä¹ˆå»è·³æ§½å•Š</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ä¸€ã€å‰è¨€&quot;&gt;&lt;a href=&quot;#ä¸€ã€å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;ä¸€ã€å‰è¨€&quot;&gt;&lt;/a&gt;ä¸€ã€å‰è¨€&lt;/h2&gt;&lt;p&gt;Handler åœ¨æˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­éšå¤„å¯è§ï¼Œä¸€èˆ¬ç”¨æ¥è§£å†³å­çº¿ç¨‹æ— æ³•è®¿é—®ä¸»çº¿ç¨‹ï¼ˆUI çº¿ç¨‹ï¼‰ä¸­çš„ UI é—®é¢˜çš„ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹æ–‡ä¼šé€šè¿‡ Handler çš„åŸºæœ¬ç”¨æ³•ï¼Œå¹¶æ·±å…¥æºç æµ…æ Handler çš„è¿è¡Œæœºåˆ¶ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://wangpeiyuan.cn/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>Android device monitor åœ¨ Mac ä¸Šæ— æ³•ç‚¹å‡»çš„è§£å†³æ–¹æ¡ˆ</title>
    <link href="http://wangpeiyuan.cn/2019/10/10/Android-device-monitor-freezes-on-mac/"/>
    <id>http://wangpeiyuan.cn/2019/10/10/Android-device-monitor-freezes-on-mac/</id>
    <published>2019-10-10T07:07:30.000Z</published>
    <updated>2020-04-02T01:58:10.884Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨ Mac ä¸Šä½¿ç”¨ Android device monitor å¤šæ¬¡é‡åˆ°æ— æ³•ç‚¹å‡»ä»¥åŠä¸€æ‰“å¼€å°±å¼¹å‡º An error has occurred çš„é”™è¯¯å¼¹çª—ï¼Œä¸»è¦çš„åŸå› æ˜¯å‡çº§äº†ç›¸å…³äº† SDK å¯¼è‡´å‡ºç°é—®é¢˜ã€‚åœ¨ç½‘ä¸Šæœç´¢è§£å†³æ–¹æ¡ˆç»å¤§å¤šæ•°çš„ç­”æ¡ˆæ˜¯å°† Java SDK çš„ç‰ˆæœ¬é™åˆ°ä¸€ä¸ªæŒ‡å®šç‰ˆæœ¬ï¼Œéå¾—é™çº§ä¸å¯å—ï¼Œå¦‚æœä¸é™çº§å°±æ²¡æœ‰è§£å†³æ–¹æ¡ˆå—ï¼Ÿç»è¿‡æˆ‘å„ç§æœç´¢å„ç§å°è¯•ç»ˆäºåœ¨ Stackoverflow ä¸Šæœç´¢åˆ°ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ <a href="https://stackoverflow.com/questions/47089757/android-device-monitor-freezes-on-mac-os-x/47090518" target="_blank" rel="noopener">Android device monitor freezes on Mac OS X</a> ï¼Œå°±åœ¨æ­¤ç®€å•åšä¸ªè®°å½•ã€‚</p><a id="more"></a><p>å¯¹äºæ— æ³•ç‚¹å‡»çš„é—®é¢˜ï¼Œé¦–å…ˆå…ˆä¸‹è½½ <a href="https://www.eclipse.org/downloads/download.php?file=/eclipse/downloads/drops4/R-4.7.1a-201710090410/swt-4.7.1a-cocoa-macosx-x86_64.zip" target="_blank" rel="noopener">swt-4.7.1a-cocoa-macosx-x86_64.zip</a>ï¼›ç„¶åï¼Œè§£å‹ï¼Œé‡å‘½åè§£å‹æ–‡ä»¶ä¸­çš„ swt.jar æ–‡ä»¶åç§°ä¸º Android/sdk/tools/lib/monitor-x86_64/plugins ä¸­ org.eclipse.swt.cocoa.macosx.x86_64â€¦jar çš„åå­—ï¼›æœ€åæ‹·è´è¿‡æ¥è¦†ç›– SDK ä¸­çš„æ–‡ä»¶å°±è§£å†³æ— æ³•ç‚¹å‡»çš„ç›¸å…³é—®é¢˜ã€‚</p><p>æ‰“å¼€ Android device monitor ä¼šå¼¹å‡º An error has occurred çš„é”™è¯¯å¼¹çª—æš‚æ—¶æ²¡æœ‰æ‰¾åˆ°å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œç”±äºæˆ‘å¹¶æ²¡æœ‰å°è¯•é™çº§ Java SDK çš„æ–¹æ¡ˆï¼Œå¹¶ä¸ç¡®å®šé™çº§æ˜¯å¦å¯ä»¥è§£å†³ï¼Œé‚£æˆ‘çš„è§£å†³æ–¹å¼æ¯”è¾ƒç®€å•ç²—æš´é‡æ–°ä¸‹è½½ Android SDK å°±è§£å†³äº†æ­¤é—®é¢˜ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘åœ¨ Mac ä¸Šä½¿ç”¨ Android device monitor å¤šæ¬¡é‡åˆ°æ— æ³•ç‚¹å‡»ä»¥åŠä¸€æ‰“å¼€å°±å¼¹å‡º An error has occurred çš„é”™è¯¯å¼¹çª—ï¼Œä¸»è¦çš„åŸå› æ˜¯å‡çº§äº†ç›¸å…³äº† SDK å¯¼è‡´å‡ºç°é—®é¢˜ã€‚åœ¨ç½‘ä¸Šæœç´¢è§£å†³æ–¹æ¡ˆç»å¤§å¤šæ•°çš„ç­”æ¡ˆæ˜¯å°† Java SDK çš„ç‰ˆæœ¬é™åˆ°ä¸€ä¸ªæŒ‡å®šç‰ˆæœ¬ï¼Œéå¾—é™çº§ä¸å¯å—ï¼Œå¦‚æœä¸é™çº§å°±æ²¡æœ‰è§£å†³æ–¹æ¡ˆå—ï¼Ÿç»è¿‡æˆ‘å„ç§æœç´¢å„ç§å°è¯•ç»ˆäºåœ¨ Stackoverflow ä¸Šæœç´¢åˆ°ä¸€ä¸ªè§£å†³æ–¹æ¡ˆ &lt;a href=&quot;https://stackoverflow.com/questions/47089757/android-device-monitor-freezes-on-mac-os-x/47090518&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Android device monitor freezes on Mac OS X&lt;/a&gt; ï¼Œå°±åœ¨æ­¤ç®€å•åšä¸ªè®°å½•ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Android" scheme="http://wangpeiyuan.cn/categories/Android/"/>
    
    
      <category term="Tip" scheme="http://wangpeiyuan.cn/tags/Tip/"/>
    
  </entry>
  
</feed>
